<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-system-design/chapter5" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Chapter 5 | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://imwito.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://imwito.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://imwito.github.io/docs/system-design/chapter5"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Chapter 5 | My Site"><meta data-rh="true" name="description" content="System Design Interviews"><meta data-rh="true" property="og:description" content="System Design Interviews"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://imwito.github.io/docs/system-design/chapter5"><link data-rh="true" rel="alternate" href="https://imwito.github.io/docs/system-design/chapter5" hreflang="en"><link data-rh="true" rel="alternate" href="https://imwito.github.io/zh-Hans/docs/system-design/chapter5" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://imwito.github.io/docs/system-design/chapter5" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Atom Feed">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.466a89db.css">
<link rel="preload" href="/assets/js/runtime~main.c8929489.js" as="script">
<link rel="preload" href="/assets/js/main.ece51ca9.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">My Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/imwito/imwito.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/system-design/chapter5" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-Hans/docs/system-design/chapter5" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-Hans">简体中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/system-design">System Design</a><button aria-label="Toggle the collapsible sidebar category &#x27;System Design&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/system-design/intro">Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/system-design/chapter1">Chapter 1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/system-design/chapter2">Chapter 2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/system-design/chapter3">Chapter 3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/system-design/chapter4">Chapter 4</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/system-design/chapter5">Chapter 5</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/tutorial---basics">Tutorial - Basics</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorial - Basics&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/tutorial---extras">Tutorial - Extras</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorial - Extras&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/system-design"><span itemprop="name">System Design</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Chapter 5</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Chapter 5</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="system-design-interviews">System Design Interviews<a href="#system-design-interviews" class="hash-link" aria-label="Direct link to System Design Interviews" title="Direct link to System Design Interviews">​</a></h2><p>System design is a very extensive topic and system design interviews are designed to evaluate your capability to produce technical solutions to abstract problems, as such, they&#x27;re not designed for a specific answer. The unique aspect of system design interviews is the two-way nature between the candidate and the interviewer.</p><p>Expectations are quite different at different engineering levels as well. This is because someone with a lot of practical experience will approach it quite differently from someone who&#x27;s new in the industry. As a result, it&#x27;s hard to come up with a single strategy that will help us stay organized during the interview.</p><p>Let&#x27;s look at some common strategies for system design interviews:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="requirements-clarifications">Requirements clarifications<a href="#requirements-clarifications" class="hash-link" aria-label="Direct link to Requirements clarifications" title="Direct link to Requirements clarifications">​</a></h3><p>System design interview questions, by nature, are vague or abstract. Asking questions about the exact scope of the problem, and clarifying functional requirements early in the interview is essential. Usually, requirements are divided into three parts:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="functional-requirements">Functional requirements<a href="#functional-requirements" class="hash-link" aria-label="Direct link to Functional requirements" title="Direct link to Functional requirements">​</a></h4><p>These are the requirements that the end user specifically demands as basic functionalities that the system should offer. All these functionalities need to be necessarily incorporated into the system as part of the contract.</p><p>For example:</p><ul><li>&quot;What are the features that we need to design for this system?&quot;</li><li>&quot;What are the edge cases we need to consider, if any, in our design?&quot;</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="non-functional-requirements">Non-functional requirements<a href="#non-functional-requirements" class="hash-link" aria-label="Direct link to Non-functional requirements" title="Direct link to Non-functional requirements">​</a></h4><p>These are the quality constraints that the system must satisfy according to the project contract. The priority or extent to which these factors are implemented varies from one project to another. They are also called non-behavioral requirements. For example, portability, maintainability, reliability, scalability, security, etc.</p><p>For example:</p><ul><li>&quot;Each request should be processed with the minimum latency&quot;</li><li>&quot;System should be highly available&quot;</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="extended-requirements">Extended requirements<a href="#extended-requirements" class="hash-link" aria-label="Direct link to Extended requirements" title="Direct link to Extended requirements">​</a></h4><p>These are basically &quot;nice to have&quot; requirements that might be out of the scope of the system.</p><p>For example:</p><ul><li>&quot;Our system should record metrics and analytics&quot;</li><li>&quot;Service health and performance monitoring?&quot;</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="estimation-and-constraints">Estimation and Constraints<a href="#estimation-and-constraints" class="hash-link" aria-label="Direct link to Estimation and Constraints" title="Direct link to Estimation and Constraints">​</a></h3><p>Estimate the scale of the system we&#x27;re going to design. It is important to ask questions such as:</p><ul><li>&quot;What is the desired scale that this system will need to handle?&quot;</li><li>&quot;What is the read/write ratio of our system?&quot;</li><li>&quot;How many requests per second?&quot;</li><li>&quot;How much storage will be needed?&quot;</li></ul><p>These questions will help us scale our design later.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-model-design">Data model design<a href="#data-model-design" class="hash-link" aria-label="Direct link to Data model design" title="Direct link to Data model design">​</a></h3><p>Once we have the estimations, we can start with defining the database schema. Doing so in the early stages of the interview would help us to understand the data flow which is the core of every system. In this step, we basically define all the entities and relationships between them.</p><ul><li>&quot;What are the different entities in the system?&quot;</li><li>&quot;What are the relationships between these entities?&quot;</li><li>&quot;How many tables do we need?&quot;</li><li>&quot;Is NoSQL a better choice here?&quot;</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-design">API design<a href="#api-design" class="hash-link" aria-label="Direct link to API design" title="Direct link to API design">​</a></h3><p>Next, we can start designing APIs for the system. These APIs will help us define the expectations from the system explicitly. We don&#x27;t have to write any code, just a simple interface defining the API requirements such as parameters, functions, classes, types, entities, etc.</p><p>For example:</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">createUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> email</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">User</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It is advised to keep the interface as simple as possible and come back to it later when covering extended requirements.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-component-design">High-level component design<a href="#high-level-component-design" class="hash-link" aria-label="Direct link to High-level component design" title="Direct link to High-level component design">​</a></h3><p>Now we have established our data model and API design, it&#x27;s time to identify system components (such as Load Balancers, API Gateway, etc.) that are needed to solve our problem and draft the first design of our system.</p><ul><li>&quot;Is it best to design a monolithic or a microservices architecture?&quot;</li><li>&quot;What type of database should we use?&quot;</li></ul><p>Once we have a basic diagram, we can start discussing with the interviewer how the system will work from the client&#x27;s perspective.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="detailed-design">Detailed design<a href="#detailed-design" class="hash-link" aria-label="Direct link to Detailed design" title="Direct link to Detailed design">​</a></h3><p>Now it&#x27;s time to go into detail about the major components of the system we designed. As always discuss with the interviewer which component may need further improvements.</p><p>Here is a good opportunity to demonstrate your experience in the areas of your expertise. Present different approaches, advantages, and disadvantages. Explain your design decisions, and back them up with examples. This is also a good time to discuss any additional features the system might be able to support, though this is optional.</p><ul><li>&quot;How should we partition our data?&quot;</li><li>&quot;What about load distribution?&quot;</li><li>&quot;Should we use cache?&quot;</li><li>&quot;How will we handle a sudden spike in traffic?&quot;</li></ul><p>Also, try not to be too opinionated about certain technologies, statements like &quot;I believe that NoSQL databases are just better, SQL databases are not scalable&quot; reflect poorly. As someone who has interviewed a lot of people over the years, my two cents here would be to be humble about what you know and what you do not. Use your existing knowledge with examples to navigate this part of the interview.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="identify-and-resolve-bottlenecks">Identify and resolve bottlenecks<a href="#identify-and-resolve-bottlenecks" class="hash-link" aria-label="Direct link to Identify and resolve bottlenecks" title="Direct link to Identify and resolve bottlenecks">​</a></h3><p>Finally, it&#x27;s time to discuss bottlenecks and approaches to mitigate them. Here are some important questions to ask:</p><ul><li>&quot;Do we have enough database replicas?&quot;</li><li>&quot;Is there any single point of failure?&quot;</li><li>&quot;Is database sharding required?&quot;</li><li>&quot;How can we make our system more robust?&quot;</li><li>&quot;How to improve the availability of our cache?&quot;</li></ul><p>Make sure to read the engineering blog of the company you&#x27;re interviewing with. This will help you get a sense of what technology stack they&#x27;re using and which problems are important to them.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="url-shortener">URL Shortener<a href="#url-shortener" class="hash-link" aria-label="Direct link to URL Shortener" title="Direct link to URL Shortener">​</a></h2><p>Let&#x27;s design a URL shortener, similar to services like <a href="https://bitly.com" target="_blank" rel="noopener noreferrer">Bitly</a>, <a href="https://tinyurl.com/app" target="_blank" rel="noopener noreferrer">TinyURL</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-a-url-shortener">What is a URL Shortener?<a href="#what-is-a-url-shortener" class="hash-link" aria-label="Direct link to What is a URL Shortener?" title="Direct link to What is a URL Shortener?">​</a></h3><p>A URL shortener service creates an alias or a short URL for a long URL. Users are redirected to the original URL when they visit these short links.</p><p>For example, the following long URL can be changed to a shorter URL.</p><p><strong>Long URL</strong>: <a href="https://karanpratapsingh.com/courses/system-design/url-shortener" target="_blank" rel="noopener noreferrer">https://karanpratapsingh.com/courses/system-design/url-shortener</a></p><p><strong>Short URL</strong>: <a href="https://bit.ly/3I71d3o" target="_blank" rel="noopener noreferrer">https://bit.ly/3I71d3o</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-do-we-need-a-url-shortener">Why do we need a URL shortener?<a href="#why-do-we-need-a-url-shortener" class="hash-link" aria-label="Direct link to Why do we need a URL shortener?" title="Direct link to Why do we need a URL shortener?">​</a></h3><p>URL shortener saves space in general when we are sharing URLs. Users are also less likely to mistype shorter URLs. Moreover, we can also optimize links across devices, this allows us to track individual links.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="requirements">Requirements<a href="#requirements" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements">​</a></h3><p>Our URL shortening system should meet the following requirements:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="functional-requirements-1">Functional requirements<a href="#functional-requirements-1" class="hash-link" aria-label="Direct link to Functional requirements" title="Direct link to Functional requirements">​</a></h4><ul><li>Given a URL, our service should generate a <em>shorter and unique</em> alias for it.</li><li>Users should be redirected to the original URL when they visit the short link.</li><li>Links should expire after a default timespan.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="non-functional-requirements-1">Non-functional requirements<a href="#non-functional-requirements-1" class="hash-link" aria-label="Direct link to Non-functional requirements" title="Direct link to Non-functional requirements">​</a></h4><ul><li>High availability with minimal latency.</li><li>The system should be scalable and efficient.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="extended-requirements-1">Extended requirements<a href="#extended-requirements-1" class="hash-link" aria-label="Direct link to Extended requirements" title="Direct link to Extended requirements">​</a></h4><ul><li>Prevent abuse of services.</li><li>Record analytics and metrics for redirections.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="estimation-and-constraints-1">Estimation and Constraints<a href="#estimation-and-constraints-1" class="hash-link" aria-label="Direct link to Estimation and Constraints" title="Direct link to Estimation and Constraints">​</a></h3><p>Let&#x27;s start with the estimation and constraints.</p><p><em>Note: Make sure to check any scale or traffic related assumptions with your interviewer.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="traffic">Traffic<a href="#traffic" class="hash-link" aria-label="Direct link to Traffic" title="Direct link to Traffic">​</a></h4><p>This will be a read-heavy system, so let&#x27;s assume a <code>100:1</code> read/write ratio with 100 million links generated per month.</p><p><strong>Reads/Writes Per month</strong></p><p>For reads per month:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>100</mn><mo>×</mo><mn>100</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mn>10</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">/</mi><mi>m</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">100 \times 100 \space million = 10 \space billion/month</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">100</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">10</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">/</span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span></span></span></span></span></div><p>Similarly for writes:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>1</mn><mo>×</mo><mn>100</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mn>100</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">/</mi><mi>m</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">1 \times 100 \space million = 100 \space million/month</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">/</span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span></span></span></span></span></div><p><strong>What would be Requests Per Second (RPS) for our system?</strong></p><p>100 million requests per month translate into 40 requests per second.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mn>100</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mrow><mo stretchy="false">(</mo><mn>30</mn><mtext> </mtext><mi>d</mi><mi>a</mi><mi>y</mi><mi>s</mi><mo>×</mo><mn>24</mn><mtext> </mtext><mi>h</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>3600</mn><mtext> </mtext><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mi>s</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo>∼</mo><mn>40</mn><mtext> </mtext><mi>U</mi><mi>R</mi><mi>L</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">\frac{100 \space million}{(30 \space days \times 24 \space hrs \times 3600 \space seconds)} = \sim 40 \space URLs/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3074em;vertical-align:-0.936em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">30</span><span class="mspace"> </span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">ys</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">24</span><span class="mspace"> </span><span class="mord mathnormal">h</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">3600</span><span class="mspace"> </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">40</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">L</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><p>And with a <code>100:1</code> read/write ratio, the number of redirections will be:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>100</mn><mo>×</mo><mn>40</mn><mtext> </mtext><mi>U</mi><mi>R</mi><mi>L</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mo>=</mo><mn>4000</mn><mtext> </mtext><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">100 \times 40 \space URLs/second = 4000 \space requests/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">100</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">40</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">L</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">4000</span><span class="mspace"> </span><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bandwidth">Bandwidth<a href="#bandwidth" class="hash-link" aria-label="Direct link to Bandwidth" title="Direct link to Bandwidth">​</a></h4><p>Since we expect about 40 URLs every second, and if we assume each request is of size 500 bytes then the total incoming data for write requests would be:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>40</mn><mo>×</mo><mn>500</mn><mtext> </mtext><mi>b</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mo>=</mo><mn>20</mn><mtext> </mtext><mi>K</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">40 \times 500 \space bytes = 20 \space KB/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">40</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">500</span><span class="mspace"> </span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mord mathnormal">t</span><span class="mord mathnormal">es</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">20</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.07153em">K</span><span class="mord mathnormal" style="margin-right:0.05017em">B</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><p>Similarly, for the read requests, since we expect about 4K redirections, the total outgoing data would be:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>4000</mn><mtext> </mtext><mi>U</mi><mi>R</mi><mi>L</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mo>×</mo><mn>500</mn><mtext> </mtext><mi>b</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mo>=</mo><mo>∼</mo><mn>2</mn><mtext> </mtext><mi>M</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">4000 \space URLs/second \times 500 \space bytes = \sim 2 \space MB/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">4000</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">L</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">500</span><span class="mspace"> </span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mord mathnormal">t</span><span class="mord mathnormal">es</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">2</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">MB</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="storage">Storage<a href="#storage" class="hash-link" aria-label="Direct link to Storage" title="Direct link to Storage">​</a></h4><p>For storage, we will assume we store each link or record in our database for 10 years. Since we expect around 100M new requests every month, the total number of records we will need to store would be:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>100</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>10</mn><mtext> </mtext><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>12</mn><mtext> </mtext><mi>m</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>h</mi><mi>s</mi><mo>=</mo><mn>12</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">100 \space million \times 10\space years \times 12 \space months = 12 \space billion</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">10</span><span class="mspace"> </span><span class="mord mathnormal">ye</span><span class="mord mathnormal">a</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord">12</span><span class="mspace"> </span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord">12</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span></span></div><p>Like earlier, if we assume each stored record will be approximately 500 bytes. We will need around 6TB of storage:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>12</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>500</mn><mtext> </mtext><mi>b</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mo>=</mo><mn>6</mn><mtext> </mtext><mi>T</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">12 \space billion \times 500 \space bytes = 6 \space TB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">12</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">500</span><span class="mspace"> </span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mord mathnormal">t</span><span class="mord mathnormal">es</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">6</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cache">Cache<a href="#cache" class="hash-link" aria-label="Direct link to Cache" title="Direct link to Cache">​</a></h4><p>For caching, we will follow the classic <a href="https://en.wikipedia.org/wiki/Pareto_principle" target="_blank" rel="noopener noreferrer">Pareto principle</a> also known as the 80/20 rule. This means that 80% of the requests are for 20% of the data, so we can cache around 20% of our requests.</p><p>Since we get around 4K read or redirection requests each second, this translates into 350M requests per day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>4000</mn><mtext> </mtext><mi>U</mi><mi>R</mi><mi>L</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mo>×</mo><mn>24</mn><mtext> </mtext><mi>h</mi><mi>o</mi><mi>u</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>3600</mn><mtext> </mtext><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mi>s</mi><mo>=</mo><mo>∼</mo><mn>350</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext> </mtext><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">4000 \space URLs/second \times 24 \space hours \times 3600 \space seconds = \sim 350 \space million \space requests/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">4000</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">L</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">24</span><span class="mspace"> </span><span class="mord mathnormal">h</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord">3600</span><span class="mspace"> </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">350</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace"> </span><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p>Hence, we will need around 35GB of memory per day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>20</mn><mtext> </mtext><mi>p</mi><mi>e</mi><mi>r</mi><mi>c</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo>×</mo><mn>350</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>500</mn><mtext> </mtext><mi>b</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mo>=</mo><mn>35</mn><mtext> </mtext><mi>G</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">20 \space percent \times 350 \space million \times 500 \space bytes = 35 \space GB/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">20</span><span class="mspace"> </span><span class="mord mathnormal">p</span><span class="mord mathnormal">erce</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">350</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">500</span><span class="mspace"> </span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mord mathnormal">t</span><span class="mord mathnormal">es</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">35</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">GB</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-estimate">High-level estimate<a href="#high-level-estimate" class="hash-link" aria-label="Direct link to High-level estimate" title="Direct link to High-level estimate">​</a></h3><p>Here is our high-level estimate:</p><table><thead><tr><th>Type</th><th>Estimate</th></tr></thead><tbody><tr><td>Writes (New URLs)</td><td>40/s</td></tr><tr><td>Reads (Redirection)</td><td>4K/s</td></tr><tr><td>Bandwidth (Incoming)</td><td>20 KB/s</td></tr><tr><td>Bandwidth (Outgoing)</td><td>2 MB/s</td></tr><tr><td>Storage (10 years)</td><td>6 TB</td></tr><tr><td>Memory (Caching)</td><td>~35 GB/day</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-model-design-1">Data model design<a href="#data-model-design-1" class="hash-link" aria-label="Direct link to Data model design" title="Direct link to Data model design">​</a></h3><p>Next, we will focus on the data model design. Here is our database schema:</p><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/url-shortener/url-shortener-datamodel.png" alt="url-shortener-datamodel" class="img_ev3q"></p><p>Initially, we can get started with just two tables:</p><p><strong>users</strong></p><p>Stores user&#x27;s details such as <code>name</code>, <code>email</code>, <code>createdAt</code>, etc.</p><p><strong>urls</strong></p><p>Contains the new short URL&#x27;s properties such as <code>expiration</code>, <code>hash</code>, <code>originalURL</code>, and <code>userID</code> of the user who created the short URL. We can also use the <code>hash</code> column as an <a href="https://karanpratapsingh.com/courses/system-design/indexes" target="_blank" rel="noopener noreferrer">index</a> to improve the query performance.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-kind-of-database-should-we-use">What kind of database should we use?<a href="#what-kind-of-database-should-we-use" class="hash-link" aria-label="Direct link to What kind of database should we use?" title="Direct link to What kind of database should we use?">​</a></h4><p>Since the data is not strongly relational, NoSQL databases such as <a href="https://aws.amazon.com/dynamodb" target="_blank" rel="noopener noreferrer">Amazon DynamoDB</a>, <a href="https://cassandra.apache.org/_/index.html" target="_blank" rel="noopener noreferrer">Apache Cassandra</a>, or <a href="https://www.mongodb.com" target="_blank" rel="noopener noreferrer">MongoDB</a> will be a better choice here, if we do decide to use an SQL database then we can use something like <a href="https://azure.microsoft.com/en-in/products/azure-sql/database" target="_blank" rel="noopener noreferrer">Azure SQL Database</a> or <a href="https://aws.amazon.com/rds" target="_blank" rel="noopener noreferrer">Amazon RDS</a>.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/sql-vs-nosql-databases" target="_blank" rel="noopener noreferrer">SQL vs NoSQL</a>.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-design-1">API design<a href="#api-design-1" class="hash-link" aria-label="Direct link to API design" title="Direct link to API design">​</a></h3><p>Let us do a basic API design for our services:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-url">Create URL<a href="#create-url" class="hash-link" aria-label="Direct link to Create URL" title="Direct link to Create URL">​</a></h4><p>This API should create a new short URL in our system given an original URL.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">createURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apiKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> originalURL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> expiration</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Date</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>API Key (<code>string</code>): API key provided by the user.</p><p>Original URL (<code>string</code>): Original URL to be shortened.</p><p>Expiration (<code>Date</code>): Expiration date of the new URL <em>(optional)</em>.</p><p><strong>Returns</strong></p><p>Short URL (<code>string</code>): New shortened URL.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="get-url">Get URL<a href="#get-url" class="hash-link" aria-label="Direct link to Get URL" title="Direct link to Get URL">​</a></h4><p>This API should retrieve the original URL from a given short URL.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">getURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apiKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shortURL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>API Key (<code>string</code>): API key provided by the user.</p><p>Short URL (<code>string</code>): Short URL mapped to the original URL.</p><p><strong>Returns</strong></p><p>Original URL (<code>string</code>): Original URL to be retrieved.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="delete-url">Delete URL<a href="#delete-url" class="hash-link" aria-label="Direct link to Delete URL" title="Direct link to Delete URL">​</a></h4><p>This API should delete a given shortURL from our system.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">deleteURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apiKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shortURL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>API Key (<code>string</code>): API key provided by the user.</p><p>Short URL (<code>string</code>): Short URL to be deleted.</p><p><strong>Returns</strong></p><p>Result (<code>boolean</code>): Represents whether the operation was successful or not.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="why-do-we-need-an-api-key">Why do we need an API key?<a href="#why-do-we-need-an-api-key" class="hash-link" aria-label="Direct link to Why do we need an API key?" title="Direct link to Why do we need an API key?">​</a></h4><p>As you must&#x27;ve noticed, we&#x27;re using an API key to prevent abuse of our services. Using this API key we can limit the users to a certain number of requests per second or minute. This is quite a standard practice for developer APIs and should cover our extended requirement.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-design">High-level design<a href="#high-level-design" class="hash-link" aria-label="Direct link to High-level design" title="Direct link to High-level design">​</a></h3><p>Now let us do a high-level design of our system.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="url-encoding">URL Encoding<a href="#url-encoding" class="hash-link" aria-label="Direct link to URL Encoding" title="Direct link to URL Encoding">​</a></h4><p>Our system&#x27;s primary goal is to shorten a given URL, let&#x27;s look at different approaches:</p><p><strong>Base62 Approach</strong></p><p>In this approach, we can encode the original URL using <a href="https://en.wikipedia.org/wiki/Base62" target="_blank" rel="noopener noreferrer">Base62</a> which consists of the capital letters A-Z, the lower case letters a-z, and the numbers 0-9.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>N</mi><mi>u</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>r</mi><mtext> </mtext><mi>o</mi><mi>f</mi><mtext> </mtext><mi>U</mi><mi>R</mi><mi>L</mi><mi>s</mi><mo>=</mo><mn>6</mn><msup><mn>2</mn><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">Number \space of \space URLs = 62^N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10903em">N</span><span class="mord mathnormal">u</span><span class="mord mathnormal">mb</span><span class="mord mathnormal" style="margin-right:0.02778em">er</span><span class="mspace"> </span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">L</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8913em"></span><span class="mord">6</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span></span></span></span></span></span></span></span></span></span></span></span></div><p>Where,</p><p><code>N</code>: Number of characters in the generated URL.</p><p>So, if we want to generate a URL that is 7 characters long, we will generate ~3.5 trillion different URLs.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="center" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mn>6</mn><msup><mn>2</mn><mn>5</mn></msup><mo>=</mo><mo>∼</mo><mn>916</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext> </mtext><mi>U</mi><mi>R</mi><mi>L</mi><mi>s</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mn>6</mn><msup><mn>2</mn><mn>6</mn></msup><mo>=</mo><mo>∼</mo><mn>56.8</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext> </mtext><mi>U</mi><mi>R</mi><mi>L</mi><mi>s</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mn>6</mn><msup><mn>2</mn><mn>7</mn></msup><mo>=</mo><mo>∼</mo><mn>3.5</mn><mtext> </mtext><mi>t</mi><mi>r</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext> </mtext><mi>U</mi><mi>R</mi><mi>L</mi><mi>s</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{gather*} 62^5 = \sim 916 \space million \space URLs \\ 62^6 = \sim 56.8 \space billion \space URLs \\ 62^7 = \sim 3.5 \space trillion \space URLs \end{gather*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.5723em;vertical-align:-2.0362em"></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5362em"><span style="top:-4.6721em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">6</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">916</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">L</span><span class="mord mathnormal">s</span></span></span><span style="top:-3.1479em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">6</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">56.8</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">L</span><span class="mord mathnormal">s</span></span></span><span style="top:-1.6238em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">6</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">7</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">3.5</span><span class="mspace"> </span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">L</span><span class="mord mathnormal">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.0362em"><span></span></span></span></span></span></span></span></span></span></span></span></div><p>This is the simplest solution here, but it does not guarantee non-duplicate or collision-resistant keys.</p><p><strong>MD5 Approach</strong></p><p>The <a href="https://en.wikipedia.org/wiki/MD5" target="_blank" rel="noopener noreferrer">MD5 message-digest algorithm</a> is a widely used hash function producing a 128-bit hash value (or 32 hexadecimal digits). We can use these 32 hexadecimal digits for generating 7 characters long URL.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>M</mi><mi>D</mi><mn>5</mn><mo stretchy="false">(</mo><mi>o</mi><mi>r</mi><mi>i</mi><mi>g</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>l</mi><mi mathvariant="normal">_</mi><mi>u</mi><mi>r</mi><mi>l</mi><mo stretchy="false">)</mo><mo>→</mo><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mn>62</mn><mi>e</mi><mi>n</mi><mi>c</mi><mi>o</mi><mi>d</mi><mi>e</mi><mo>→</mo><mi>h</mi><mi>a</mi><mi>s</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">MD5(original\_url) \rightarrow base62encode \rightarrow hash</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em"></span><span class="mord mathnormal" style="margin-right:0.10903em">M</span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mord">5</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em">or</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">ina</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal">se</span><span class="mord">62</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">co</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">ha</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span></span></span></span></span></div><p>However, this creates a new issue for us, which is duplication and collision. We can try to re-compute the hash until we find a unique one but that will increase the overhead of our systems. It&#x27;s better to look for more scalable approaches.</p><p><strong>Counter Approach</strong></p><p>In this approach, we will start with a single server which will maintain the count of the keys generated. Once our service receives a request, it can reach out to the counter which returns a unique number and increments the counter. When the next request comes the counter again returns the unique number and this goes on.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo stretchy="false">(</mo><mn>0</mn><mo>−</mo><mn>3.5</mn><mtext> </mtext><mi>t</mi><mi>r</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">)</mo><mo>→</mo><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mn>62</mn><mi>e</mi><mi>n</mi><mi>c</mi><mi>o</mi><mi>d</mi><mi>e</mi><mo>→</mo><mi>h</mi><mi>a</mi><mi>s</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">Counter(0-3.5 \space trillion) \rightarrow base62encode \rightarrow hash</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em">er</span><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">3.5</span><span class="mspace"> </span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal">se</span><span class="mord">62</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">co</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">ha</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span></span></span></span></span></div><p>The problem with this approach is that it can quickly become a single point for failure. And if we run multiple instances of the counter we can have collision as it&#x27;s essentially a distributed system.</p><p>To solve this issue we can use a distributed system manager such as <a href="https://zookeeper.apache.org" target="_blank" rel="noopener noreferrer">Zookeeper</a> which can provide distributed synchronization. Zookeeper can maintain multiple ranges for our servers.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>R</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi>e</mi><mtext> </mtext><mn>1</mn><mo>:</mo><mtext> </mtext><mn>1</mn><mo>→</mo><mn>1</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>000</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>R</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi>e</mi><mtext> </mtext><mn>2</mn><mo>:</mo><mtext> </mtext><mn>1</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>001</mn><mo>→</mo><mn>2</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>000</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>R</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi>e</mi><mtext> </mtext><mn>3</mn><mo>:</mo><mtext> </mtext><mn>2</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>001</mn><mo>→</mo><mn>3</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>000</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*} &amp; Range \space 1: \space 1 \rightarrow 1,000,000 \\ &amp; Range \space 2: \space 1,000,001 \rightarrow 2,000,000 \\ &amp; Range \space 3: \space 2,000,001 \rightarrow 3,000,000 \\ &amp; ... \end{align*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6em;vertical-align:-2.75em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.25em"><span class="pstrut" style="height:2.84em"></span><span class="mord"></span></span><span style="top:-3.75em"><span class="pstrut" style="height:2.84em"></span><span class="mord"></span></span><span style="top:-2.25em"><span class="pstrut" style="height:2.84em"></span><span class="mord"></span></span><span style="top:-0.75em"><span class="pstrut" style="height:2.84em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">an</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">e</span><span class="mspace"> </span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span></span></span><span style="top:-3.91em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">an</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">e</span><span class="mspace"> </span><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">001</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">an</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">e</span><span class="mspace"> </span><span class="mord">3</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">001</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span></span></span><span style="top:-0.91em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mord">...</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span></span></span></span></span></span></span></div><p>Once a server reaches its maximum range Zookeeper will assign an unused counter range to the new server. This approach can guarantee non-duplicate and collision-resistant URLs. Also, we can run multiple instances of Zookeeper to remove the single point of failure.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="key-generation-service-kgs">Key Generation Service (KGS)<a href="#key-generation-service-kgs" class="hash-link" aria-label="Direct link to Key Generation Service (KGS)" title="Direct link to Key Generation Service (KGS)">​</a></h4><p>As we discussed, generating a unique key at scale without duplication and collisions can be a bit of a challenge. To solve this problem, we can create a standalone Key Generation Service (KGS) that generates a unique key ahead of time and stores it in a separate database for later use. This approach can make things simple for us.</p><p><strong>How to handle concurrent access?</strong></p><p>Once the key is used, we can mark it in the database to make sure we don&#x27;t reuse it, however, if there are multiple server instances reading data concurrently, two or more servers might try to use the same key.</p><p>The easiest way to solve this would be to store keys in two tables. As soon as a key is used, we move it to a separate table with appropriate locking in place. Also, to improve reads, we can keep some of the keys in memory.</p><p><strong>KGS database estimations</strong></p><p>As per our discussion, we can generate up to ~56.8 billion unique 6 character long keys which will result in us having to store 300 GB of keys.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>6</mn><mtext> </mtext><mi>c</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>56.8</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mo>∼</mo><mn>390</mn><mtext> </mtext><mi>G</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">6 \space characters \times 56.8 \space billion = \sim 390 \space GB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">6</span><span class="mspace"> </span><span class="mord mathnormal">c</span><span class="mord mathnormal">ha</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ers</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord">56.8</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">390</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">GB</span></span></span></span></span></div><p>While 390 GB seems like a lot for this simple use case, it is important to remember this is for the entirety of our service lifetime and the size of the keys database would not increase like our main database.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="caching">Caching<a href="#caching" class="hash-link" aria-label="Direct link to Caching" title="Direct link to Caching">​</a></h4><p>Now, let&#x27;s talk about <a href="https://karanpratapsingh.com/courses/system-design/caching" target="_blank" rel="noopener noreferrer">caching</a>. As per our estimations, we will require around ~35 GB of memory per day to cache 20% of the incoming requests to our services. For this use case, we can use <a href="https://redis.io" target="_blank" rel="noopener noreferrer">Redis</a> or <a href="https://memcached.org" target="_blank" rel="noopener noreferrer">Memcached</a> servers alongside our API server.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/caching" target="_blank" rel="noopener noreferrer">caching</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="design">Design<a href="#design" class="hash-link" aria-label="Direct link to Design" title="Direct link to Design">​</a></h4><p>Now that we have identified some core components, let&#x27;s do the first draft of our system design.</p><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/url-shortener/url-shortener-basic-design.png" alt="url-shortener-basic-design" class="img_ev3q"></p><p>Here&#x27;s how it works:</p><p><strong>Creating a new URL</strong></p><ol><li>When a user creates a new URL, our API server requests a new unique key from the Key Generation Service (KGS).</li><li>Key Generation Service provides a unique key to the API server and marks the key as used.</li><li>API server writes the new URL entry to the database and cache.</li><li>Our service returns an HTTP 201 (Created) response to the user.</li></ol><p><strong>Accessing a URL</strong></p><ol><li>When a client navigates to a certain short URL, the request is sent to the API servers.</li><li>The request first hits the cache, and if the entry is not found there then it is retrieved from the database and an HTTP 301 (Redirect) is issued to the original URL.</li><li>If the key is still not found in the database, an HTTP 404 (Not found) error is sent to the user.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="detailed-design-1">Detailed design<a href="#detailed-design-1" class="hash-link" aria-label="Direct link to Detailed design" title="Direct link to Detailed design">​</a></h3><p>It&#x27;s time to discuss the finer details of our design.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="data-partitioning">Data Partitioning<a href="#data-partitioning" class="hash-link" aria-label="Direct link to Data Partitioning" title="Direct link to Data Partitioning">​</a></h4><p>To scale out our databases we will need to partition our data. Horizontal partitioning (aka <a href="https://karanpratapsingh.com/courses/system-design/sharding" target="_blank" rel="noopener noreferrer">Sharding</a>) can be a good first step. We can use partitions schemes such as:</p><ul><li>Hash-Based Partitioning</li><li>List-Based Partitioning</li><li>Range Based Partitioning</li><li>Composite Partitioning</li></ul><p>The above approaches can still cause uneven data and load distribution, we can solve this using <a href="https://karanpratapsingh.com/courses/system-design/consistent-hashing" target="_blank" rel="noopener noreferrer">Consistent hashing</a>.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/sharding" target="_blank" rel="noopener noreferrer">Sharding</a> and <a href="https://karanpratapsingh.com/courses/system-design/consistent-hashing" target="_blank" rel="noopener noreferrer">Consistent Hashing</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="database-cleanup">Database cleanup<a href="#database-cleanup" class="hash-link" aria-label="Direct link to Database cleanup" title="Direct link to Database cleanup">​</a></h4><p>This is more of a maintenance step for our services and depends on whether we keep the expired entries or remove them. If we do decide to remove expired entries, we can approach this in two different ways:</p><p><strong>Active cleanup</strong></p><p>In active cleanup, we will run a separate cleanup service which will periodically remove expired links from our storage and cache. This will be a very lightweight service like a <a href="https://en.wikipedia.org/wiki/Cron" target="_blank" rel="noopener noreferrer">cron job</a>.</p><p><strong>Passive cleanup</strong></p><p>For passive cleanup, we can remove the entry when a user tries to access an expired link. This can ensure a lazy cleanup of our database and cache.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cache-1">Cache<a href="#cache-1" class="hash-link" aria-label="Direct link to Cache" title="Direct link to Cache">​</a></h4><p>Now let us talk about <a href="https://karanpratapsingh.com/courses/system-design/caching" target="_blank" rel="noopener noreferrer">caching</a>.</p><p><strong>Which cache eviction policy to use?</strong></p><p>As we discussed before, we can use solutions like <a href="https://redis.io" target="_blank" rel="noopener noreferrer">Redis</a> or <a href="https://memcached.org" target="_blank" rel="noopener noreferrer">Memcached</a> and cache 20% of the daily traffic but what kind of cache eviction policy would best fit our needs?</p><p><a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_(LRU)" target="_blank" rel="noopener noreferrer">Least Recently Used (LRU)</a> can be a good policy for our system. In this policy, we discard the least recently used key first.</p><p><strong>How to handle cache miss?</strong></p><p>Whenever there is a cache miss, our servers can hit the database directly and update the cache with the new entries.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics-and-analytics">Metrics and Analytics<a href="#metrics-and-analytics" class="hash-link" aria-label="Direct link to Metrics and Analytics" title="Direct link to Metrics and Analytics">​</a></h4><p>Recording analytics and metrics is one of our extended requirements. We can store and update metadata like visitor&#x27;s country, platform, the number of views, etc alongside the URL entry in our database.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="security">Security<a href="#security" class="hash-link" aria-label="Direct link to Security" title="Direct link to Security">​</a></h4><p>For security, we can introduce private URLs and authorization. A separate table can be used to store user ids that have permission to access a specific URL. If a user does not have proper permissions, we can return an HTTP 401 (Unauthorized) error.</p><p>We can also use an <a href="https://karanpratapsingh.com/courses/system-design/api-gateway" target="_blank" rel="noopener noreferrer">API Gateway</a> as they can support capabilities like authorization, rate limiting, and load balancing out of the box.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="identify-and-resolve-bottlenecks-1">Identify and resolve bottlenecks<a href="#identify-and-resolve-bottlenecks-1" class="hash-link" aria-label="Direct link to Identify and resolve bottlenecks" title="Direct link to Identify and resolve bottlenecks">​</a></h3><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/url-shortener/url-shortener-advanced-design.png" alt="url-shortener-advanced-design" class="img_ev3q"></p><p>Let us identify and resolve bottlenecks such as single points of failure in our design:</p><ul><li>&quot;What if the API service or Key Generation Service crashes?&quot;</li><li>&quot;How will we distribute our traffic between our components?&quot;</li><li>&quot;How can we reduce the load on our database?&quot;</li><li>&quot;What if the key database used by KGS fails?&quot;</li><li>&quot;How to improve the availability of our cache?&quot;</li></ul><p>To make our system more resilient we can do the following:</p><ul><li>Running multiple instances of our Servers and Key Generation Service.</li><li>Introducing <a href="https://karanpratapsingh.com/courses/system-design/load-balancing" target="_blank" rel="noopener noreferrer">load balancers</a> between clients, servers, databases, and cache servers.</li><li>Using multiple read replicas for our database as it&#x27;s a read-heavy system.</li><li>Standby replica for our key database in case it fails.</li><li>Multiple instances and replicas for our distributed cache.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whatsapp">WhatsApp<a href="#whatsapp" class="hash-link" aria-label="Direct link to WhatsApp" title="Direct link to WhatsApp">​</a></h2><p>Let&#x27;s design a <a href="https://whatsapp.com" target="_blank" rel="noopener noreferrer">WhatsApp</a> like instant messaging service, similar to services like <a href="https://www.messenger.com" target="_blank" rel="noopener noreferrer">Facebook Messenger</a>, and <a href="https://www.wechat.com" target="_blank" rel="noopener noreferrer">WeChat</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-whatsapp">What is WhatsApp?<a href="#what-is-whatsapp" class="hash-link" aria-label="Direct link to What is WhatsApp?" title="Direct link to What is WhatsApp?">​</a></h3><p>WhatsApp is a chat application that provides instant messaging services to its users. It is one of the most used mobile applications on the planet, connecting over 2 billion users in 180+ countries. WhatsApp is also available on the web.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="requirements-1">Requirements<a href="#requirements-1" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements">​</a></h3><p>Our system should meet the following requirements:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="functional-requirements-2">Functional requirements<a href="#functional-requirements-2" class="hash-link" aria-label="Direct link to Functional requirements" title="Direct link to Functional requirements">​</a></h4><ul><li>Should support one-on-one chat.</li><li>Group chats (max 100 people).</li><li>Should support file sharing (image, video, etc.).</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="non-functional-requirements-2">Non-functional requirements<a href="#non-functional-requirements-2" class="hash-link" aria-label="Direct link to Non-functional requirements" title="Direct link to Non-functional requirements">​</a></h4><ul><li>High availability with minimal latency.</li><li>The system should be scalable and efficient.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="extended-requirements-2">Extended requirements<a href="#extended-requirements-2" class="hash-link" aria-label="Direct link to Extended requirements" title="Direct link to Extended requirements">​</a></h4><ul><li>Sent, Delivered, and Read receipts of the messages.</li><li>Show the last seen time of users.</li><li>Push notifications.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="estimation-and-constraints-2">Estimation and Constraints<a href="#estimation-and-constraints-2" class="hash-link" aria-label="Direct link to Estimation and Constraints" title="Direct link to Estimation and Constraints">​</a></h3><p>Let&#x27;s start with the estimation and constraints.</p><p><em>Note: Make sure to check any scale or traffic-related assumptions with your interviewer.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="traffic-1">Traffic<a href="#traffic-1" class="hash-link" aria-label="Direct link to Traffic" title="Direct link to Traffic">​</a></h4><p>Let us assume we have 50 million daily active users (DAU) and on average each user sends at least 10 messages to 4 different people every day. This gives us 2 billion messages per day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>50</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>40</mn><mtext> </mtext><mi>m</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi>s</mi><mo>=</mo><mn>2</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">50 \space million \times 40 \space messages = 2 \space billion/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">50</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">40</span><span class="mspace"> </span><span class="mord mathnormal">m</span><span class="mord mathnormal">ess</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">es</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">2</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p>Messages can also contain media such as images, videos, or other files. We can assume that 5 percent of messages are media files shared by the users, which gives us additional 100 million files we would need to store.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>5</mn><mtext> </mtext><mi>p</mi><mi>e</mi><mi>r</mi><mi>c</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo>×</mo><mn>2</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mn>100</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">5 \space percent \times 2 \space billion = 100 \space million/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">5</span><span class="mspace"> </span><span class="mord mathnormal">p</span><span class="mord mathnormal">erce</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord">2</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p><strong>What would be Requests Per Second (RPS) for our system?</strong></p><p>2 billion requests per day translate into 24K requests per second.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mn>2</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mrow><mo stretchy="false">(</mo><mn>24</mn><mtext> </mtext><mi>h</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>3600</mn><mtext> </mtext><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mi>s</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo>∼</mo><mn>24</mn><mi>K</mi><mtext> </mtext><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">\frac{2 \space billion}{(24 \space hrs \times 3600 \space seconds)} = \sim 24K \space requests/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3074em;vertical-align:-0.936em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">24</span><span class="mspace"> </span><span class="mord mathnormal">h</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">3600</span><span class="mspace"> </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">2</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">24</span><span class="mord mathnormal" style="margin-right:0.07153em">K</span><span class="mspace"> </span><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="storage-1">Storage<a href="#storage-1" class="hash-link" aria-label="Direct link to Storage" title="Direct link to Storage">​</a></h4><p>If we assume each message on average is 100 bytes, we will require about 200 GB of database storage every day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>2</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>100</mn><mtext> </mtext><mi>b</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mo>=</mo><mo>∼</mo><mn>200</mn><mtext> </mtext><mi>G</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">2 \space billion \times 100 \space bytes = \sim 200 \space GB/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">2</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mord mathnormal">t</span><span class="mord mathnormal">es</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">200</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">GB</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p>As per our requirements, we also know that around 5 percent of our daily messages (100 million) are media files. If we assume each file is 100 KB on average, we will require 10 TB of storage every day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>100</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>100</mn><mtext> </mtext><mi>K</mi><mi>B</mi><mo>=</mo><mn>10</mn><mtext> </mtext><mi>T</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">100 \space million \times 100 \space KB = 10 \space TB/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.07153em">K</span><span class="mord mathnormal" style="margin-right:0.05017em">B</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">10</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p>And for 10 years, we will require about 38 PB of storage.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mn>10</mn><mtext> </mtext><mi>T</mi><mi>B</mi><mo>+</mo><mn>0.2</mn><mtext> </mtext><mi>T</mi><mi>B</mi><mo stretchy="false">)</mo><mo>×</mo><mn>10</mn><mtext> </mtext><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>365</mn><mtext> </mtext><mi>d</mi><mi>a</mi><mi>y</mi><mi>s</mi><mo>=</mo><mo>∼</mo><mn>38</mn><mtext> </mtext><mi>P</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">(10 \space TB + 0.2 \space TB) \times 10 \space years \times 365 \space days = \sim 38 \space PB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">10</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">0.2</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">10</span><span class="mspace"> </span><span class="mord mathnormal">ye</span><span class="mord mathnormal">a</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">365</span><span class="mspace"> </span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">ys</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">38</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">PB</span></span></span></span></span></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bandwidth-1">Bandwidth<a href="#bandwidth-1" class="hash-link" aria-label="Direct link to Bandwidth" title="Direct link to Bandwidth">​</a></h3><p>As our system is handling 10.2 TB of ingress every day, we will require a minimum bandwidth of around 120 MB per second.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mn>10.2</mn><mtext> </mtext><mi>T</mi><mi>B</mi></mrow><mrow><mo stretchy="false">(</mo><mn>24</mn><mtext> </mtext><mi>h</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>3600</mn><mtext> </mtext><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mi>s</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo>∼</mo><mn>120</mn><mtext> </mtext><mi>M</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">\frac{10.2 \space TB}{(24 \space hrs \times 3600 \space seconds)} = \sim 120 \space MB/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2963em;vertical-align:-0.936em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">24</span><span class="mspace"> </span><span class="mord mathnormal">h</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">3600</span><span class="mspace"> </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">10.2</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">120</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">MB</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-estimate-1">High-level estimate<a href="#high-level-estimate-1" class="hash-link" aria-label="Direct link to High-level estimate" title="Direct link to High-level estimate">​</a></h3><p>Here is our high-level estimate:</p><table><thead><tr><th>Type</th><th>Estimate</th></tr></thead><tbody><tr><td>Daily active users (DAU)</td><td>50 million</td></tr><tr><td>Requests per second (RPS)</td><td>24K/s</td></tr><tr><td>Storage (per day)</td><td>~10.2 TB</td></tr><tr><td>Storage (10 years)</td><td>~38 PB</td></tr><tr><td>Bandwidth</td><td>~120 MB/s</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-model-design-2">Data model design<a href="#data-model-design-2" class="hash-link" aria-label="Direct link to Data model design" title="Direct link to Data model design">​</a></h3><p>This is the general data model which reflects our requirements.</p><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/whatsapp/whatsapp-datamodel.png" alt="whatsapp-datamodel" class="img_ev3q"></p><p>We have the following tables:</p><p><strong>users</strong></p><p>This table will contain a user&#x27;s information such as <code>name</code>, <code>phoneNumber</code>, and other details.</p><p><strong>messages</strong></p><p>As the name suggests, this table will store messages with properties such as <code>type</code> (text, image, video, etc.), <code>content</code>, and timestamps for message delivery. The message will also have a corresponding <code>chatID</code> or <code>groupID</code>.</p><p><strong>chats</strong></p><p>This table basically represents a private chat between two users and can contain multiple messages.</p><p><strong>users_chats</strong></p><p>This table maps users and chats as multiple users can have multiple chats (N:M relationship) and vice versa.</p><p><strong>groups</strong></p><p>This table represents a group made up of multiple users.</p><p><strong>users_groups</strong></p><p>This table maps users and groups as multiple users can be a part of multiple groups (N:M relationship) and vice versa.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-kind-of-database-should-we-use-1">What kind of database should we use?<a href="#what-kind-of-database-should-we-use-1" class="hash-link" aria-label="Direct link to What kind of database should we use?" title="Direct link to What kind of database should we use?">​</a></h4><p>While our data model seems quite relational, we don&#x27;t necessarily need to store everything in a single database, as this can limit our scalability and quickly become a bottleneck.</p><p>We will split the data between different services each having ownership over a particular table. Then we can use a relational database such as <a href="https://www.postgresql.org" target="_blank" rel="noopener noreferrer">PostgreSQL</a> or a distributed NoSQL database such as <a href="https://cassandra.apache.org/_/index.html" target="_blank" rel="noopener noreferrer">Apache Cassandra</a> for our use case.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-design-2">API design<a href="#api-design-2" class="hash-link" aria-label="Direct link to API design" title="Direct link to API design">​</a></h3><p>Let us do a basic API design for our services:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="get-all-chats-or-groups">Get all chats or groups<a href="#get-all-chats-or-groups" class="hash-link" aria-label="Direct link to Get all chats or groups" title="Direct link to Get all chats or groups">​</a></h4><p>This API will get all chats or groups for a given <code>userID</code>.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">getAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Chat</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">Group</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>User ID (<code>UUID</code>): ID of the current user.</p><p><strong>Returns</strong></p><p>Result (<code>Chat[] | Group[]</code>): All the chats and groups the user is a part of.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="get-messages">Get messages<a href="#get-messages" class="hash-link" aria-label="Direct link to Get messages" title="Direct link to Get messages">​</a></h4><p>Get all messages for a user given the <code>channelID</code> (chat or group id).</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">getMessages</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> channelID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Message</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>User ID (<code>UUID</code>): ID of the current user.</p><p>Channel ID (<code>UUID</code>): ID of the channel (chat or group) from which messages need to be retrieved.</p><p><strong>Returns</strong></p><p>Messages (<code>Message[]</code>): All the messages in a given chat or group.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="send-message">Send message<a href="#send-message" class="hash-link" aria-label="Direct link to Send message" title="Direct link to Send message">​</a></h4><p>Send a message from a user to a channel (chat or group).</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sendMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> channelID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>User ID (<code>UUID</code>): ID of the current user.</p><p>Channel ID (<code>UUID</code>): ID of the channel (chat or group) user wants to send a message to.</p><p>Message (<code>Message</code>): The message (text, image, video, etc.) that the user wants to send.</p><p><strong>Returns</strong></p><p>Result (<code>boolean</code>): Represents whether the operation was successful or not.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="join-or-leave-a-channel">Join or leave a channel<a href="#join-or-leave-a-channel" class="hash-link" aria-label="Direct link to Join or leave a channel" title="Direct link to Join or leave a channel">​</a></h4><p>Allows the user to join or leave a channel (chat or group).</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">joinGroup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> channelID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">leaveGroup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> channelID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>User ID (<code>UUID</code>): ID of the current user.</p><p>Channel ID (<code>UUID</code>): ID of the channel (chat or group) the user wants to join or leave.</p><p><strong>Returns</strong></p><p>Result (<code>boolean</code>): Represents whether the operation was successful or not.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-design-1">High-level design<a href="#high-level-design-1" class="hash-link" aria-label="Direct link to High-level design" title="Direct link to High-level design">​</a></h3><p>Now let us do a high-level design of our system.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a href="#architecture" class="hash-link" aria-label="Direct link to Architecture" title="Direct link to Architecture">​</a></h4><p>We will be using <a href="https://karanpratapsingh.com/courses/system-design/monoliths-microservices#microservices" target="_blank" rel="noopener noreferrer">microservices architecture</a> since it will make it easier to horizontally scale and decouple our services. Each service will have ownership of its own data model. Let&#x27;s try to divide our system into some core services.</p><p><strong>User Service</strong></p><p>This is an HTTP-based service that handles user-related concerns such as authentication and user information.</p><p><strong>Chat Service</strong></p><p>The chat service will use WebSockets and establish connections with the client to handle chat and group message-related functionality. We can also use cache to keep track of all the active connections sort of like sessions which will help us determine if the user is online or not.</p><p><strong>Notification Service</strong></p><p>This service will simply send push notifications to the users. It will be discussed in detail separately.</p><p><strong>Presence Service</strong></p><p>The presence service will keep track of the <em>last seen</em> status of all users. It will be discussed in detail separately.</p><p><strong>Media service</strong></p><p>This service will handle the media (images, videos, files, etc.) uploads. It will be discussed in detail separately.</p><p><strong>What about inter-service communication and service discovery?</strong></p><p>Since our architecture is microservices-based, services will be communicating with each other as well. Generally, REST or HTTP performs well but we can further improve the performance using <a href="https://karanpratapsingh.com/courses/system-design/rest-graphql-grpc#grpc" target="_blank" rel="noopener noreferrer">gRPC</a> which is more lightweight and efficient.</p><p><a href="https://karanpratapsingh.com/courses/system-design/service-discovery" target="_blank" rel="noopener noreferrer">Service discovery</a> is another thing we will have to take into account. We can also use a service mesh that enables managed, observable, and secure communication between individual services.</p><p><em>Note: Learn more about <a href="https://karanpratapsingh.com/courses/system-design/rest-graphql-grpc" target="_blank" rel="noopener noreferrer">REST, GraphQL, gRPC</a> and how they compare with each other.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="real-time-messaging">Real-time messaging<a href="#real-time-messaging" class="hash-link" aria-label="Direct link to Real-time messaging" title="Direct link to Real-time messaging">​</a></h4><p>How do we efficiently send and receive messages? We have two different options:</p><p><strong>Pull model</strong></p><p>The client can periodically send an HTTP request to servers to check if there are any new messages. This can be achieved via something like <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events#long-polling" target="_blank" rel="noopener noreferrer">Long polling</a>.</p><p><strong>Push model</strong></p><p>The client opens a long-lived connection with the server and once new data is available it will be pushed to the client. We can use <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events#websockets" target="_blank" rel="noopener noreferrer">WebSockets</a> or <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events#server-sent-events-sse" target="_blank" rel="noopener noreferrer">Server-Sent Events (SSE)</a> for this.</p><p>The pull model approach is not scalable as it will create unnecessary request overhead on our servers and most of the time the response will be empty, thus wasting our resources. To minimize latency, using the push model with <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events#websockets" target="_blank" rel="noopener noreferrer">WebSockets</a> is a better choice because then we can push data to the client once it&#x27;s available without any delay, given the connection is open with the client. Also, WebSockets provide full-duplex communication, unlike <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events#server-sent-events-sse" target="_blank" rel="noopener noreferrer">Server-Sent Events (SSE)</a> which are only unidirectional.</p><p><em>Note: Learn more about <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events" target="_blank" rel="noopener noreferrer">Long polling, WebSockets, Server-Sent Events (SSE)</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="last-seen">Last seen<a href="#last-seen" class="hash-link" aria-label="Direct link to Last seen" title="Direct link to Last seen">​</a></h4><p>To implement the last seen functionality, we can use a <a href="https://en.wikipedia.org/wiki/Heartbeat_(computing)" target="_blank" rel="noopener noreferrer">heartbeat</a> mechanism, where the client can periodically ping the servers indicating its liveness. Since this needs to be as low overhead as possible, we can store the last active timestamp in the cache as follows:</p><table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody><tr><td>User A</td><td>2022-07-01T14:32:50</td></tr><tr><td>User B</td><td>2022-07-05T05:10:35</td></tr><tr><td>User C</td><td>2022-07-10T04:33:25</td></tr></tbody></table><p>This will give us the last time the user was active. This functionality will be handled by the presence service combined with <a href="https://redis.io" target="_blank" rel="noopener noreferrer">Redis</a> or <a href="https://memcached.org" target="_blank" rel="noopener noreferrer">Memcached</a> as our cache.</p><p>Another way to implement this is to track the latest action of the user, once the last activity crosses a certain threshold, such as <em>&quot;user hasn&#x27;t performed any action in the last 30 seconds&quot;</em>, we can show the user as offline and last seen with the last recorded timestamp. This will be more of a lazy update approach and might benefit us over heartbeat in certain cases.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="notifications">Notifications<a href="#notifications" class="hash-link" aria-label="Direct link to Notifications" title="Direct link to Notifications">​</a></h4><p>Once a message is sent in a chat or a group, we will first check if the recipient is active or not, we can get this information by taking the user&#x27;s active connection and last seen into consideration.</p><p>If the recipient is not active, the chat service will add an event to a <a href="https://karanpratapsingh.com/courses/system-design/message-queues" target="_blank" rel="noopener noreferrer">message queue</a> with additional metadata such as the client&#x27;s device platform which will be used to route the notification to the correct platform later on.</p><p>The notification service will then consume the event from the message queue and forward the request to <a href="https://firebase.google.com/docs/cloud-messaging" target="_blank" rel="noopener noreferrer">Firebase Cloud Messaging (FCM)</a> or <a href="https://developer.apple.com/documentation/usernotifications" target="_blank" rel="noopener noreferrer">Apple Push Notification Service (APNS)</a> based on the client&#x27;s device platform (Android, iOS, web, etc). We can also add support for email and SMS.</p><p><strong>Why are we using a message queue?</strong></p><p>Since most message queues provide best-effort ordering which ensures that messages are generally delivered in the same order as they&#x27;re sent and that a message is delivered at least once which is an important part of our service functionality.</p><p>While this seems like a classic <a href="https://karanpratapsingh.com/courses/system-design/publish-subscribe" target="_blank" rel="noopener noreferrer">publish-subscribe</a> use case, it is actually not as mobile devices and browsers each have their own way of handling push notifications. Usually, notifications are handled externally via Firebase Cloud Messaging (FCM) or Apple Push Notification Service (APNS) unlike message fan-out which we commonly see in backend services. We can use something like <a href="https://aws.amazon.com/sqs" target="_blank" rel="noopener noreferrer">Amazon SQS</a> or <a href="https://www.rabbitmq.com" target="_blank" rel="noopener noreferrer">RabbitMQ</a> to support this functionality.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="read-receipts">Read receipts<a href="#read-receipts" class="hash-link" aria-label="Direct link to Read receipts" title="Direct link to Read receipts">​</a></h4><p>Handling read receipts can be tricky, for this use case we can wait for some sort of <a href="https://en.wikipedia.org/wiki/Acknowledgement_(data_networks)" target="_blank" rel="noopener noreferrer">Acknowledgment (ACK)</a> from the client to determine if the message was delivered and update the corresponding <code>deliveredAt</code> field. Similarly, we will mark the message as seen once the user opens the chat and update the corresponding <code>seenAt</code> timestamp field.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="design-1">Design<a href="#design-1" class="hash-link" aria-label="Direct link to Design" title="Direct link to Design">​</a></h4><p>Now that we have identified some core components, let&#x27;s do the first draft of our system design.</p><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/whatsapp/whatsapp-basic-design.png" alt="whatsapp-basic-design" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="detailed-design-2">Detailed design<a href="#detailed-design-2" class="hash-link" aria-label="Direct link to Detailed design" title="Direct link to Detailed design">​</a></h3><p>It&#x27;s time to discuss our design decisions in detail.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="data-partitioning-1">Data Partitioning<a href="#data-partitioning-1" class="hash-link" aria-label="Direct link to Data Partitioning" title="Direct link to Data Partitioning">​</a></h4><p>To scale out our databases we will need to partition our data. Horizontal partitioning (aka <a href="https://karanpratapsingh.com/courses/system-design/sharding" target="_blank" rel="noopener noreferrer">Sharding</a>) can be a good first step. We can use partitions schemes such as:</p><ul><li>Hash-Based Partitioning</li><li>List-Based Partitioning</li><li>Range Based Partitioning</li><li>Composite Partitioning</li></ul><p>The above approaches can still cause uneven data and load distribution, we can solve this using <a href="https://karanpratapsingh.com/courses/system-design/consistent-hashing" target="_blank" rel="noopener noreferrer">Consistent hashing</a>.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/sharding" target="_blank" rel="noopener noreferrer">Sharding</a> and <a href="https://karanpratapsingh.com/courses/system-design/consistent-hashing" target="_blank" rel="noopener noreferrer">Consistent Hashing</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="caching-1">Caching<a href="#caching-1" class="hash-link" aria-label="Direct link to Caching" title="Direct link to Caching">​</a></h4><p>In a messaging application, we have to be careful about using cache as our users expect the latest data, but many users will be requesting the same messages, especially in a group chat. So, to prevent usage spikes from our resources we can cache older messages.</p><p>Some group chats can have thousands of messages and sending that over the network will be really inefficient, to improve efficiency we can add pagination to our system APIs. This decision will be helpful for users with limited network bandwidth as they won&#x27;t have to retrieve old messages unless requested.</p><p><strong>Which cache eviction policy to use?</strong></p><p>We can use solutions like <a href="https://redis.io" target="_blank" rel="noopener noreferrer">Redis</a> or <a href="https://memcached.org" target="_blank" rel="noopener noreferrer">Memcached</a> and cache 20% of the daily traffic but what kind of cache eviction policy would best fit our needs?</p><p><a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_(LRU)" target="_blank" rel="noopener noreferrer">Least Recently Used (LRU)</a> can be a good policy for our system. In this policy, we discard the least recently used key first.</p><p><strong>How to handle cache miss?</strong></p><p>Whenever there is a cache miss, our servers can hit the database directly and update the cache with the new entries.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/caching" target="_blank" rel="noopener noreferrer">Caching</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="media-access-and-storage">Media access and storage<a href="#media-access-and-storage" class="hash-link" aria-label="Direct link to Media access and storage" title="Direct link to Media access and storage">​</a></h4><p>As we know, most of our storage space will be used for storing media files such as images, videos, or other files. Our media service will be handling both access and storage of the user media files.</p><p>But where can we store files at scale? Well, <a href="https://karanpratapsingh.com/courses/system-design/storage#object-storage" target="_blank" rel="noopener noreferrer">object storage</a> is what we&#x27;re looking for. Object stores break data files up into pieces called objects. It then stores those objects in a single repository, which can be spread out across multiple networked systems. We can also use distributed file storage such as <a href="https://karanpratapsingh.com/courses/system-design/storage#hdfs" target="_blank" rel="noopener noreferrer">HDFS</a> or <a href="https://www.gluster.org" target="_blank" rel="noopener noreferrer">GlusterFS</a>.</p><p><em>Fun fact: WhatsApp deletes media on its servers once it has been downloaded by the user.</em></p><p>We can use object stores like <a href="https://aws.amazon.com/s3" target="_blank" rel="noopener noreferrer">Amazon S3</a>, <a href="https://azure.microsoft.com/en-in/services/storage/blobs" target="_blank" rel="noopener noreferrer">Azure Blob Storage</a>, or <a href="https://cloud.google.com/storage" target="_blank" rel="noopener noreferrer">Google Cloud Storage</a> for this use case.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="content-delivery-network-cdn">Content Delivery Network (CDN)<a href="#content-delivery-network-cdn" class="hash-link" aria-label="Direct link to Content Delivery Network (CDN)" title="Direct link to Content Delivery Network (CDN)">​</a></h4><p><a href="https://karanpratapsingh.com/courses/system-design/content-delivery-network" target="_blank" rel="noopener noreferrer">Content Delivery Network (CDN)</a> increases content availability and redundancy while reducing bandwidth costs. Generally, static files such as images, and videos are served from CDN. We can use services like <a href="https://aws.amazon.com/cloudfront" target="_blank" rel="noopener noreferrer">Amazon CloudFront</a> or <a href="https://www.cloudflare.com/cdn" target="_blank" rel="noopener noreferrer">Cloudflare CDN</a> for this use case.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="api-gateway">API gateway<a href="#api-gateway" class="hash-link" aria-label="Direct link to API gateway" title="Direct link to API gateway">​</a></h4><p>Since we will be using multiple protocols like HTTP, WebSocket, TCP/IP, deploying multiple L4 (transport layer) or L7 (application layer) type load balancers separately for each protocol will be expensive. Instead, we can use an <a href="https://karanpratapsingh.com/courses/system-design/api-gateway" target="_blank" rel="noopener noreferrer">API Gateway</a> that supports multiple protocols without any issues.</p><p>API Gateway can also offer other features such as authentication, authorization, rate limiting, throttling, and API versioning which will improve the quality of our services.</p><p>We can use services like <a href="https://aws.amazon.com/api-gateway" target="_blank" rel="noopener noreferrer">Amazon API Gateway</a> or <a href="https://azure.microsoft.com/en-in/services/api-management" target="_blank" rel="noopener noreferrer">Azure API Gateway</a> for this use case.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="identify-and-resolve-bottlenecks-2">Identify and resolve bottlenecks<a href="#identify-and-resolve-bottlenecks-2" class="hash-link" aria-label="Direct link to Identify and resolve bottlenecks" title="Direct link to Identify and resolve bottlenecks">​</a></h3><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/whatsapp/whatsapp-advanced-design.png" alt="whatsapp-advanced-design" class="img_ev3q"></p><p>Let us identify and resolve bottlenecks such as single points of failure in our design:</p><ul><li>&quot;What if one of our services crashes?&quot;</li><li>&quot;How will we distribute our traffic between our components?&quot;</li><li>&quot;How can we reduce the load on our database?&quot;</li><li>&quot;How to improve the availability of our cache?&quot;</li><li>&quot;Wouldn&#x27;t API Gateway be a single point of failure?&quot;</li><li>&quot;How can we make our notification system more robust?&quot;</li><li>&quot;How can we reduce media storage costs&quot;?</li><li>&quot;Does chat service has too much responsibility?&quot;</li></ul><p>To make our system more resilient we can do the following:</p><ul><li>Running multiple instances of each of our services.</li><li>Introducing <a href="https://karanpratapsingh.com/courses/system-design/load-balancing" target="_blank" rel="noopener noreferrer">load balancers</a> between clients, servers, databases, and cache servers.</li><li>Using multiple read replicas for our databases.</li><li>Multiple instances and replicas for our distributed cache.</li><li>We can have a standby replica of our API Gateway.</li><li>Exactly once delivery and message ordering is challenging in a distributed system, we can use a dedicated <a href="https://karanpratapsingh.com/courses/system-design/message-brokers" target="_blank" rel="noopener noreferrer">message broker</a> such as <a href="https://kafka.apache.org" target="_blank" rel="noopener noreferrer">Apache Kafka</a> or <a href="https://nats.io" target="_blank" rel="noopener noreferrer">NATS</a> to make our notification system more robust.</li><li>We can add media processing and compression capabilities to the media service to compress large files similar to WhatsApp which will save a lot of storage space and reduce cost.</li><li>We can create a group service separate from the chat service to further decouple our services.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="twitter">Twitter<a href="#twitter" class="hash-link" aria-label="Direct link to Twitter" title="Direct link to Twitter">​</a></h2><p>Let&#x27;s design a <a href="https://twitter.com" target="_blank" rel="noopener noreferrer">Twitter</a> like social media service, similar to services like <a href="https://facebook.com" target="_blank" rel="noopener noreferrer">Facebook</a>, <a href="https://instagram.com" target="_blank" rel="noopener noreferrer">Instagram</a>, etc.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-twitter">What is Twitter?<a href="#what-is-twitter" class="hash-link" aria-label="Direct link to What is Twitter?" title="Direct link to What is Twitter?">​</a></h3><p>Twitter is a social media service where users can read or post short messages (up to 280 characters) called tweets. It is available on the web and mobile platforms such as Android and iOS.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="requirements-2">Requirements<a href="#requirements-2" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements">​</a></h3><p>Our system should meet the following requirements:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="functional-requirements-3">Functional requirements<a href="#functional-requirements-3" class="hash-link" aria-label="Direct link to Functional requirements" title="Direct link to Functional requirements">​</a></h4><ul><li>Should be able to post new tweets (can be text, image, video, etc.).</li><li>Should be able to follow other users.</li><li>Should have a newsfeed feature consisting of tweets from the people the user is following.</li><li>Should be able to search tweets.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="non-functional-requirements-3">Non-Functional requirements<a href="#non-functional-requirements-3" class="hash-link" aria-label="Direct link to Non-Functional requirements" title="Direct link to Non-Functional requirements">​</a></h4><ul><li>High availability with minimal latency.</li><li>The system should be scalable and efficient.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="extended-requirements-3">Extended requirements<a href="#extended-requirements-3" class="hash-link" aria-label="Direct link to Extended requirements" title="Direct link to Extended requirements">​</a></h4><ul><li>Metrics and analytics.</li><li>Retweet functionality.</li><li>Favorite tweets.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="estimation-and-constraints-3">Estimation and Constraints<a href="#estimation-and-constraints-3" class="hash-link" aria-label="Direct link to Estimation and Constraints" title="Direct link to Estimation and Constraints">​</a></h3><p>Let&#x27;s start with the estimation and constraints.</p><p><em>Note: Make sure to check any scale or traffic-related assumptions with your interviewer.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="traffic-2">Traffic<a href="#traffic-2" class="hash-link" aria-label="Direct link to Traffic" title="Direct link to Traffic">​</a></h4><p>This will be a read-heavy system, let us assume we have 1 billion total users with 200 million daily active users (DAU), and on average each user tweets 5 times a day. This gives us 1 billion tweets per day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>200</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>5</mn><mtext> </mtext><mi>t</mi><mi>w</mi><mi>e</mi><mi>e</mi><mi>t</mi><mi>s</mi><mo>=</mo><mn>1</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">200 \space million \times 5 \space tweets = 1 \space billion/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">200</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">5</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.02691em">tw</span><span class="mord mathnormal">ee</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p>Tweets can also contain media such as images, or videos. We can assume that 10 percent of tweets are media files shared by the users, which gives us additional 100 million files we would need to store.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>10</mn><mtext> </mtext><mi>p</mi><mi>e</mi><mi>r</mi><mi>c</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo>×</mo><mn>1</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mn>100</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">10 \space percent \times 1 \space billion = 100 \space million/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">10</span><span class="mspace"> </span><span class="mord mathnormal">p</span><span class="mord mathnormal">erce</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p><strong>What would be Requests Per Second (RPS) for our system?</strong></p><p>1 billion requests per day translate into 12K requests per second.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mn>1</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mrow><mo stretchy="false">(</mo><mn>24</mn><mtext> </mtext><mi>h</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>3600</mn><mtext> </mtext><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mi>s</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo>∼</mo><mn>12</mn><mi>K</mi><mtext> </mtext><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">\frac{1 \space billion}{(24 \space hrs \times 3600 \space seconds)} = \sim 12K \space requests/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3074em;vertical-align:-0.936em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">24</span><span class="mspace"> </span><span class="mord mathnormal">h</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">3600</span><span class="mspace"> </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">12</span><span class="mord mathnormal" style="margin-right:0.07153em">K</span><span class="mspace"> </span><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="storage-2">Storage<a href="#storage-2" class="hash-link" aria-label="Direct link to Storage" title="Direct link to Storage">​</a></h4><p>If we assume each message on average is 100 bytes, we will require about 100 GB of database storage every day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>1</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>100</mn><mtext> </mtext><mi>b</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mo>=</mo><mo>∼</mo><mn>100</mn><mtext> </mtext><mi>G</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">1 \space billion \times 100 \space bytes = \sim 100 \space GB/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mord mathnormal">t</span><span class="mord mathnormal">es</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">GB</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p>We also know that around 10 percent of our daily messages (100 million) are media files per our requirements. If we assume each file is 50 KB on average, we will require 5 TB of storage every day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>100</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>50</mn><mtext> </mtext><mi>K</mi><mi>B</mi><mo>=</mo><mn>5</mn><mtext> </mtext><mi>T</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">100 \space million \times 50 \space KB = 5 \space TB/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">50</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.07153em">K</span><span class="mord mathnormal" style="margin-right:0.05017em">B</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">5</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p>And for 10 years, we will require about 19 PB of storage.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mn>5</mn><mtext> </mtext><mi>T</mi><mi>B</mi><mo>+</mo><mn>0.1</mn><mtext> </mtext><mi>T</mi><mi>B</mi><mo stretchy="false">)</mo><mo>×</mo><mn>365</mn><mtext> </mtext><mi>d</mi><mi>a</mi><mi>y</mi><mi>s</mi><mo>×</mo><mn>10</mn><mtext> </mtext><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mi>s</mi><mo>=</mo><mo>∼</mo><mn>19</mn><mtext> </mtext><mi>P</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">(5 \space TB + 0.1 \space TB) \times 365 \space days \times 10 \space years = \sim 19 \space PB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">5</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">0.1</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">365</span><span class="mspace"> </span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">ys</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">10</span><span class="mspace"> </span><span class="mord mathnormal">ye</span><span class="mord mathnormal">a</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">19</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">PB</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bandwidth-2">Bandwidth<a href="#bandwidth-2" class="hash-link" aria-label="Direct link to Bandwidth" title="Direct link to Bandwidth">​</a></h4><p>As our system is handling 5.1 TB of ingress every day, we will require a minimum bandwidth of around 60 MB per second.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mn>5.1</mn><mtext> </mtext><mi>T</mi><mi>B</mi></mrow><mrow><mo stretchy="false">(</mo><mn>24</mn><mtext> </mtext><mi>h</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>3600</mn><mtext> </mtext><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mi>s</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo>∼</mo><mn>60</mn><mtext> </mtext><mi>M</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">\frac{5.1 \space TB}{(24 \space hrs \times 3600 \space seconds)} = \sim 60 \space MB/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2963em;vertical-align:-0.936em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">24</span><span class="mspace"> </span><span class="mord mathnormal">h</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">3600</span><span class="mspace"> </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">5.1</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">60</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">MB</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-estimate-2">High-level estimate<a href="#high-level-estimate-2" class="hash-link" aria-label="Direct link to High-level estimate" title="Direct link to High-level estimate">​</a></h4><p>Here is our high-level estimate:</p><table><thead><tr><th>Type</th><th>Estimate</th></tr></thead><tbody><tr><td>Daily active users (DAU)</td><td>100 million</td></tr><tr><td>Requests per second (RPS)</td><td>12K/s</td></tr><tr><td>Storage (per day)</td><td>~5.1 TB</td></tr><tr><td>Storage (10 years)</td><td>~19 PB</td></tr><tr><td>Bandwidth</td><td>~60 MB/s</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-model-design-3">Data model design<a href="#data-model-design-3" class="hash-link" aria-label="Direct link to Data model design" title="Direct link to Data model design">​</a></h3><p>This is the general data model which reflects our requirements.</p><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/twitter/twitter-datamodel.png" alt="twitter-datamodel" class="img_ev3q"></p><p>We have the following tables:</p><p><strong>users</strong></p><p>This table will contain a user&#x27;s information such as <code>name</code>, <code>email</code>, <code>dob</code>, and other details.</p><p><strong>tweets</strong></p><p>As the name suggests, this table will store tweets and their properties such as <code>type</code> (text, image, video, etc.), <code>content</code>, etc. We will also store the corresponding <code>userID</code>.</p><p><strong>favorites</strong></p><p>This table maps tweets with users for the favorite tweets functionality in our application.</p><p><strong>followers</strong></p><p>This table maps the followers and <a href="https://en.wiktionary.org/wiki/followee" target="_blank" rel="noopener noreferrer">followees</a> as users can follow each other (N:M relationship).</p><p><strong>feeds</strong></p><p>This table stores feed properties with the corresponding <code>userID</code>.</p><p><strong>feeds_tweets</strong></p><p>This table maps tweets and feed (N:M relationship).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-kind-of-database-should-we-use-2">What kind of database should we use?<a href="#what-kind-of-database-should-we-use-2" class="hash-link" aria-label="Direct link to What kind of database should we use?" title="Direct link to What kind of database should we use?">​</a></h4><p>While our data model seems quite relational, we don&#x27;t necessarily need to store everything in a single database, as this can limit our scalability and quickly become a bottleneck.</p><p>We will split the data between different services each having ownership over a particular table. Then we can use a relational database such as <a href="https://www.postgresql.org" target="_blank" rel="noopener noreferrer">PostgreSQL</a> or a distributed NoSQL database such as <a href="https://cassandra.apache.org/_/index.html" target="_blank" rel="noopener noreferrer">Apache Cassandra</a> for our use case.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-design-3">API design<a href="#api-design-3" class="hash-link" aria-label="Direct link to API design" title="Direct link to API design">​</a></h3><p>Let us do a basic API design for our services:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="post-a-tweet">Post a tweet<a href="#post-a-tweet" class="hash-link" aria-label="Direct link to Post a tweet" title="Direct link to Post a tweet">​</a></h4><p>This API will allow the user to post a tweet on the platform.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">postTweet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mediaURL</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>User ID (<code>UUID</code>): ID of the user.</p><p>Content (<code>string</code>): Contents of the tweet.</p><p>Media URL (<code>string</code>): URL of the attached media <em>(optional)</em>.</p><p><strong>Returns</strong></p><p>Result (<code>boolean</code>): Represents whether the operation was successful or not.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="follow-or-unfollow-a-user">Follow or unfollow a user<a href="#follow-or-unfollow-a-user" class="hash-link" aria-label="Direct link to Follow or unfollow a user" title="Direct link to Follow or unfollow a user">​</a></h4><p>This API will allow the user to follow or unfollow another user.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">follow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">followerID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> followeeID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">unfollow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">followerID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> followeeID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>Follower ID (<code>UUID</code>): ID of the current user.</p><p>Followee ID (<code>UUID</code>): ID of the user we want to follow or unfollow.</p><p>Media URL (<code>string</code>): URL of the attached media <em>(optional)</em>.</p><p><strong>Returns</strong></p><p>Result (<code>boolean</code>): Represents whether the operation was successful or not.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="get-newsfeed">Get newsfeed<a href="#get-newsfeed" class="hash-link" aria-label="Direct link to Get newsfeed" title="Direct link to Get newsfeed">​</a></h4><p>This API will return all the tweets to be shown within a given newsfeed.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">getNewsfeed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Tweet</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>User ID (<code>UUID</code>): ID of the user.</p><p><strong>Returns</strong></p><p>Tweets (<code>Tweet[]</code>): All the tweets to be shown within a given newsfeed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-design-2">High-level design<a href="#high-level-design-2" class="hash-link" aria-label="Direct link to High-level design" title="Direct link to High-level design">​</a></h3><p>Now let us do a high-level design of our system.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-1">Architecture<a href="#architecture-1" class="hash-link" aria-label="Direct link to Architecture" title="Direct link to Architecture">​</a></h4><p>We will be using <a href="https://karanpratapsingh.com/courses/system-design/monoliths-microservices#microservices" target="_blank" rel="noopener noreferrer">microservices architecture</a> since it will make it easier to horizontally scale and decouple our services. Each service will have ownership of its own data model. Let&#x27;s try to divide our system into some core services.</p><p><strong>User Service</strong></p><p>This service handles user-related concerns such as authentication and user information.</p><p><strong>Newsfeed Service</strong></p><p>This service will handle the generation and publishing of user newsfeeds. It will be discussed in detail separately.</p><p><strong>Tweet Service</strong></p><p>The tweet service will handle tweet-related use cases such as posting a tweet, favorites, etc.</p><p><strong>Search Service</strong></p><p>The service is responsible for handling search-related functionality. It will be discussed in detail separately.</p><p><strong>Media service</strong></p><p>This service will handle the media (images, videos, files, etc.) uploads. It will be discussed in detail separately.</p><p><strong>Notification Service</strong></p><p>This service will simply send push notifications to the users.</p><p><strong>Analytics Service</strong></p><p>This service will be used for metrics and analytics use cases.</p><p><strong>What about inter-service communication and service discovery?</strong></p><p>Since our architecture is microservices-based, services will be communicating with each other as well. Generally, REST or HTTP performs well but we can further improve the performance using <a href="https://karanpratapsingh.com/courses/system-design/rest-graphql-grpc#grpc" target="_blank" rel="noopener noreferrer">gRPC</a> which is more lightweight and efficient.</p><p><a href="https://karanpratapsingh.com/courses/system-design/service-discovery" target="_blank" rel="noopener noreferrer">Service discovery</a> is another thing we will have to take into account. We can also use a service mesh that enables managed, observable, and secure communication between individual services.</p><p><em>Note: Learn more about <a href="https://karanpratapsingh.com/courses/system-design/rest-graphql-grpc" target="_blank" rel="noopener noreferrer">REST, GraphQL, gRPC</a> and how they compare with each other.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="newsfeed">Newsfeed<a href="#newsfeed" class="hash-link" aria-label="Direct link to Newsfeed" title="Direct link to Newsfeed">​</a></h4><p>When it comes to the newsfeed, it seems easy enough to implement, but there are a lot of things that can make or break this feature. So, let&#x27;s divide our problem into two parts:</p><p><strong>Generation</strong></p><p>Let&#x27;s assume we want to generate the feed for user A, we will perform the following steps:</p><ol><li>Retrieve the IDs of all the users and entities (hashtags, topics, etc.) user A follows.</li><li>Fetch the relevant tweets for each of the retrieved IDs.</li><li>Use a ranking algorithm to rank the tweets based on parameters such as relevance, time, engagement, etc.</li><li>Return the ranked tweets data to the client in a paginated manner.</li></ol><p>Feed generation is an intensive process and can take quite a lot of time, especially for users following a lot of people. To improve the performance, the feed can be pre-generated and stored in the cache, then we can have a mechanism to periodically update the feed and apply our ranking algorithm to the new tweets.</p><p><strong>Publishing</strong></p><p>Publishing is the step where the feed data is pushed according to each specific user. This can be a quite heavy operation, as a user may have millions of friends or followers. To deal with this, we have three different approaches:</p><ul><li>Pull Model (or Fan-out on load)</li></ul><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/twitter/newsfeed-pull-model.png" alt="newsfeed-pull-model" class="img_ev3q"></p><p>When a user creates a tweet, and a follower reloads their newsfeed, the feed is created and stored in memory. The most recent feed is only loaded when the user requests it. This approach reduces the number of write operations on our database.</p><p>The downside of this approach is that the users will not be able to view recent feeds unless they &quot;pull&quot; the data from the server, which will increase the number of read operations on the server.</p><ul><li>Push Model (or Fan-out on write)</li></ul><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/twitter/newsfeed-push-model.png" alt="newsfeed-push-model" class="img_ev3q"></p><p>In this model, once a user creates a tweet, it is &quot;pushed&quot; to all the follower&#x27;s feeds immediately. This prevents the system from having to go through a user&#x27;s entire followers list to check for updates.</p><p>However, the downside of this approach is that it would increase the number of write operations on the database.</p><ul><li>Hybrid Model</li></ul><p>A third approach is a hybrid model between the pull and push model. It combines the beneficial features of the above two models and tries to provide a balanced approach between the two.</p><p>The hybrid model allows only users with a lesser number of followers to use the push model. For users with a higher number of followers such as celebrities, the pull model is used.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="ranking-algorithm">Ranking Algorithm<a href="#ranking-algorithm" class="hash-link" aria-label="Direct link to Ranking Algorithm" title="Direct link to Ranking Algorithm">​</a></h4><p>As we discussed, we will need a ranking algorithm to rank each tweet according to its relevance to each specific user.</p><p>For example, Facebook used to utilize an <a href="https://en.wikipedia.org/wiki/EdgeRank" target="_blank" rel="noopener noreferrer">EdgeRank</a> algorithm. Here, the rank of each feed item is described by:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>a</mi><mi>n</mi><mi>k</mi><mo>=</mo><mi>A</mi><mi>f</mi><mi>f</mi><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mi>y</mi><mo>×</mo><mi>W</mi><mi>e</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mo>×</mo><mi>D</mi><mi>e</mi><mi>c</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">Rank = Affinity \times Weight \times Decay</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal" style="margin-right:0.03148em">ank</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.10764em">ff</span><span class="mord mathnormal">ini</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.13889em">W</span><span class="mord mathnormal">e</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Dec</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p>Where,</p><p><code>Affinity</code>: is the &quot;closeness&quot; of the user to the creator of the edge. If a user frequently likes, comments, or messages the edge creator, then the value of affinity will be higher, resulting in a higher rank for the post.</p><p><code>Weight</code>: is the value assigned according to each edge. A comment can have a higher weightage than likes, and thus a post with more comments is more likely to get a higher rank.</p><p><code>Decay</code>: is the measure of the creation of the edge. The older the edge, the lesser will be the value of decay and eventually the rank.</p><p>Nowadays, algorithms are much more complex and ranking is done using machine learning models which can take thousands of factors into consideration.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="retweets">Retweets<a href="#retweets" class="hash-link" aria-label="Direct link to Retweets" title="Direct link to Retweets">​</a></h4><p>Retweets are one of our extended requirements. To implement this feature, we can simply create a new tweet with the user id of the user retweeting the original tweet and then modify the <code>type</code> enum and <code>content</code> property of the new tweet to link it with the original tweet.</p><p>For example, the <code>type</code> enum property can be of type tweet, similar to text, video, etc and <code>content</code> can be the id of the original tweet. Here the first row indicates the original tweet while the second row is how we can represent a retweet.</p><table><thead><tr><th>id</th><th>userID</th><th>type</th><th>content</th><th>createdAt</th></tr></thead><tbody><tr><td>ad34-291a-45f6-b36c</td><td>7a2c-62c4-4dc8-b1bb</td><td>text</td><td>Hey, this is my first tweet…</td><td>1658905644054</td></tr><tr><td>f064-49ad-9aa2-84a6</td><td>6aa2-2bc9-4331-879f</td><td>tweet</td><td>ad34-291a-45f6-b36c</td><td>1658906165427</td></tr></tbody></table><p>This is a very basic implementation. To improve this we can create a separate table itself to store retweets.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="search">Search<a href="#search" class="hash-link" aria-label="Direct link to Search" title="Direct link to Search">​</a></h4><p>Sometimes traditional DBMS are not performant enough, we need something which allows us to store, search, and analyze huge volumes of data quickly and in near real-time and give results within milliseconds. <a href="https://www.elastic.co" target="_blank" rel="noopener noreferrer">Elasticsearch</a> can help us with this use case.</p><p><a href="https://www.elastic.co" target="_blank" rel="noopener noreferrer">Elasticsearch</a> is a distributed, free and open search and analytics engine for all types of data, including textual, numerical, geospatial, structured, and unstructured. It is built on top of <a href="https://lucene.apache.org" target="_blank" rel="noopener noreferrer">Apache Lucene</a>.</p><p><strong>How do we identify trending topics?</strong></p><p>Trending functionality will be based on top of the search functionality. We can cache the most frequently searched queries, hashtags, and topics in the last <code>N</code> seconds and update them every <code>M</code> seconds using some sort of batch job mechanism. Our ranking algorithm can also be applied to the trending topics to give them more weight and personalize them for the user.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="notifications-1">Notifications<a href="#notifications-1" class="hash-link" aria-label="Direct link to Notifications" title="Direct link to Notifications">​</a></h4><p>Push notifications are an integral part of any social media platform. We can use a message queue or a message broker such as <a href="https://kafka.apache.org" target="_blank" rel="noopener noreferrer">Apache Kafka</a> with the notification service to dispatch requests to <a href="https://firebase.google.com/docs/cloud-messaging" target="_blank" rel="noopener noreferrer">Firebase Cloud Messaging (FCM)</a> or <a href="https://developer.apple.com/documentation/usernotifications" target="_blank" rel="noopener noreferrer">Apple Push Notification Service (APNS)</a> which will handle the delivery of the push notifications to user devices.</p><p><em>For more details, refer to the <a href="https://karanpratapsingh.com/courses/system-design/whatsapp#notifications" target="_blank" rel="noopener noreferrer">WhatsApp</a> system design where we discuss push notifications in detail.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="detailed-design-3">Detailed design<a href="#detailed-design-3" class="hash-link" aria-label="Direct link to Detailed design" title="Direct link to Detailed design">​</a></h3><p>It&#x27;s time to discuss our design decisions in detail.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="data-partitioning-2">Data Partitioning<a href="#data-partitioning-2" class="hash-link" aria-label="Direct link to Data Partitioning" title="Direct link to Data Partitioning">​</a></h4><p>To scale out our databases we will need to partition our data. Horizontal partitioning (aka <a href="https://karanpratapsingh.com/courses/system-design/sharding" target="_blank" rel="noopener noreferrer">Sharding</a>) can be a good first step. We can use partitions schemes such as:</p><ul><li>Hash-Based Partitioning</li><li>List-Based Partitioning</li><li>Range Based Partitioning</li><li>Composite Partitioning</li></ul><p>The above approaches can still cause uneven data and load distribution, we can solve this using <a href="https://karanpratapsingh.com/courses/system-design/consistent-hashing" target="_blank" rel="noopener noreferrer">Consistent hashing</a>.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/sharding" target="_blank" rel="noopener noreferrer">Sharding</a> and <a href="https://karanpratapsingh.com/courses/system-design/consistent-hashing" target="_blank" rel="noopener noreferrer">Consistent Hashing</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="mutual-friends">Mutual friends<a href="#mutual-friends" class="hash-link" aria-label="Direct link to Mutual friends" title="Direct link to Mutual friends">​</a></h4><p>For mutual friends, we can build a social graph for every user. Each node in the graph will represent a user and a directional edge will represent followers and followees. After that, we can traverse the followers of a user to find and suggest a mutual friend. This would require a graph database such as <a href="https://neo4j.com" target="_blank" rel="noopener noreferrer">Neo4j</a> and <a href="https://www.arangodb.com" target="_blank" rel="noopener noreferrer">ArangoDB</a>.</p><p>This is a pretty simple algorithm, to improve our suggestion accuracy, we will need to incorporate a recommendation model which uses machine learning as part of our algorithm.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics-and-analytics-1">Metrics and Analytics<a href="#metrics-and-analytics-1" class="hash-link" aria-label="Direct link to Metrics and Analytics" title="Direct link to Metrics and Analytics">​</a></h4><p>Recording analytics and metrics is one of our extended requirements. As we will be using <a href="https://kafka.apache.org" target="_blank" rel="noopener noreferrer">Apache Kafka</a> to publish all sorts of events, we can process these events and run analytics on the data using <a href="https://spark.apache.org" target="_blank" rel="noopener noreferrer">Apache Spark</a> which is an open-source unified analytics engine for large-scale data processing.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="caching-2">Caching<a href="#caching-2" class="hash-link" aria-label="Direct link to Caching" title="Direct link to Caching">​</a></h4><p>In a social media application, we have to be careful about using cache as our users expect the latest data. So, to prevent usage spikes from our resources we can cache the top 20% of the tweets.</p><p>To further improve efficiency we can add pagination to our system APIs. This decision will be helpful for users with limited network bandwidth as they won&#x27;t have to retrieve old messages unless requested.</p><p><strong>Which cache eviction policy to use?</strong></p><p>We can use solutions like <a href="https://redis.io" target="_blank" rel="noopener noreferrer">Redis</a> or <a href="https://memcached.org" target="_blank" rel="noopener noreferrer">Memcached</a> and cache 20% of the daily traffic but what kind of cache eviction policy would best fit our needs?</p><p><a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_(LRU)" target="_blank" rel="noopener noreferrer">Least Recently Used (LRU)</a> can be a good policy for our system. In this policy, we discard the least recently used key first.</p><p><strong>How to handle cache miss?</strong></p><p>Whenever there is a cache miss, our servers can hit the database directly and update the cache with the new entries.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/caching" target="_blank" rel="noopener noreferrer">Caching</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="media-access-and-storage-1">Media access and storage<a href="#media-access-and-storage-1" class="hash-link" aria-label="Direct link to Media access and storage" title="Direct link to Media access and storage">​</a></h4><p>As we know, most of our storage space will be used for storing media files such as images, videos, or other files. Our media service will be handling both access and storage of the user media files.</p><p>But where can we store files at scale? Well, <a href="https://karanpratapsingh.com/courses/system-design/storage#object-storage" target="_blank" rel="noopener noreferrer">object storage</a> is what we&#x27;re looking for. Object stores break data files up into pieces called objects. It then stores those objects in a single repository, which can be spread out across multiple networked systems. We can also use distributed file storage such as <a href="https://karanpratapsingh.com/courses/system-design/storage#hdfs" target="_blank" rel="noopener noreferrer">HDFS</a> or <a href="https://www.gluster.org" target="_blank" rel="noopener noreferrer">GlusterFS</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="content-delivery-network-cdn-1">Content Delivery Network (CDN)<a href="#content-delivery-network-cdn-1" class="hash-link" aria-label="Direct link to Content Delivery Network (CDN)" title="Direct link to Content Delivery Network (CDN)">​</a></h4><p><a href="https://karanpratapsingh.com/courses/system-design/content-delivery-network" target="_blank" rel="noopener noreferrer">Content Delivery Network (CDN)</a> increases content availability and redundancy while reducing bandwidth costs. Generally, static files such as images, and videos are served from CDN. We can use services like <a href="https://aws.amazon.com/cloudfront" target="_blank" rel="noopener noreferrer">Amazon CloudFront</a> or <a href="https://www.cloudflare.com/cdn" target="_blank" rel="noopener noreferrer">Cloudflare CDN</a> for this use case.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="identify-and-resolve-bottlenecks-3">Identify and resolve bottlenecks<a href="#identify-and-resolve-bottlenecks-3" class="hash-link" aria-label="Direct link to Identify and resolve bottlenecks" title="Direct link to Identify and resolve bottlenecks">​</a></h3><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/twitter/twitter-advanced-design.png" alt="twitter-advanced-design" class="img_ev3q"></p><p>Let us identify and resolve bottlenecks such as single points of failure in our design:</p><ul><li>&quot;What if one of our services crashes?&quot;</li><li>&quot;How will we distribute our traffic between our components?&quot;</li><li>&quot;How can we reduce the load on our database?&quot;</li><li>&quot;How to improve the availability of our cache?&quot;</li><li>&quot;How can we make our notification system more robust?&quot;</li><li>&quot;How can we reduce media storage costs&quot;?</li></ul><p>To make our system more resilient we can do the following:</p><ul><li>Running multiple instances of each of our services.</li><li>Introducing <a href="https://karanpratapsingh.com/courses/system-design/load-balancing" target="_blank" rel="noopener noreferrer">load balancers</a> between clients, servers, databases, and cache servers.</li><li>Using multiple read replicas for our databases.</li><li>Multiple instances and replicas for our distributed cache.</li><li>Exactly once delivery and message ordering is challenging in a distributed system, we can use a dedicated <a href="https://karanpratapsingh.com/courses/system-design/message-brokers" target="_blank" rel="noopener noreferrer">message broker</a> such as <a href="https://kafka.apache.org" target="_blank" rel="noopener noreferrer">Apache Kafka</a> or <a href="https://nats.io" target="_blank" rel="noopener noreferrer">NATS</a> to make our notification system more robust.</li><li>We can add media processing and compression capabilities to the media service to compress large files which will save a lot of storage space and reduce cost.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="netflix">Netflix<a href="#netflix" class="hash-link" aria-label="Direct link to Netflix" title="Direct link to Netflix">​</a></h2><p>Let&#x27;s design a <a href="https://netflix.com" target="_blank" rel="noopener noreferrer">Netflix</a> like video streaming service, similar to services like <a href="https://www.primevideo.com" target="_blank" rel="noopener noreferrer">Amazon Prime Video</a>, <a href="https://www.disneyplus.com" target="_blank" rel="noopener noreferrer">Disney Plus</a>, <a href="https://www.hulu.com" target="_blank" rel="noopener noreferrer">Hulu</a>, <a href="https://youtube.com" target="_blank" rel="noopener noreferrer">Youtube</a>, <a href="https://vimeo.com" target="_blank" rel="noopener noreferrer">Vimeo</a>, etc.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-netflix">What is Netflix?<a href="#what-is-netflix" class="hash-link" aria-label="Direct link to What is Netflix?" title="Direct link to What is Netflix?">​</a></h3><p>Netflix is a subscription-based streaming service that allows its members to watch TV shows and movies on an internet-connected device. It is available on platforms such as the Web, iOS, Android, TV, etc.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="requirements-3">Requirements<a href="#requirements-3" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements">​</a></h3><p>Our system should meet the following requirements:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="functional-requirements-4">Functional requirements<a href="#functional-requirements-4" class="hash-link" aria-label="Direct link to Functional requirements" title="Direct link to Functional requirements">​</a></h4><ul><li>Users should be able to stream and share videos.</li><li>The content team (or users in YouTube&#x27;s case) should be able to upload new videos (movies, tv shows episodes, and other content).</li><li>Users should be able to search for videos using titles or tags.</li><li>Users should be able to comment on a video similar to YouTube.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="non-functional-requirements-4">Non-Functional requirements<a href="#non-functional-requirements-4" class="hash-link" aria-label="Direct link to Non-Functional requirements" title="Direct link to Non-Functional requirements">​</a></h4><ul><li>High availability with minimal latency.</li><li>High reliability, no uploads should be lost.</li><li>The system should be scalable and efficient.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="extended-requirements-4">Extended requirements<a href="#extended-requirements-4" class="hash-link" aria-label="Direct link to Extended requirements" title="Direct link to Extended requirements">​</a></h4><ul><li>Certain content should be <a href="https://en.wikipedia.org/wiki/Geo-blocking" target="_blank" rel="noopener noreferrer">geo-blocked</a>.</li><li>Resume video playback from the point user left off.</li><li>Record metrics and analytics of videos.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="estimation-and-constraints-4">Estimation and Constraints<a href="#estimation-and-constraints-4" class="hash-link" aria-label="Direct link to Estimation and Constraints" title="Direct link to Estimation and Constraints">​</a></h3><p>Let&#x27;s start with the estimation and constraints.</p><p><em>Note: Make sure to check any scale or traffic-related assumptions with your interviewer.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="traffic-3">Traffic<a href="#traffic-3" class="hash-link" aria-label="Direct link to Traffic" title="Direct link to Traffic">​</a></h4><p>This will be a read-heavy system, let us assume we have 1 billion total users with 200 million daily active users (DAU), and on average each user watches 5 videos a day. This gives us 1 billion videos watched per day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>200</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>5</mn><mtext> </mtext><mi>v</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>o</mi><mi>s</mi><mo>=</mo><mn>1</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">200 \space million \times 5 \space videos = 1 \space billion/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">200</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord">5</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">eos</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p>Assuming a <code>200:1</code> read/write ratio, about 5 million videos will be uploaded every day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mn>1</mn><mn>200</mn></mfrac><mo>×</mo><mn>1</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mn>5</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">\frac{1}{200} \times 1 \space billion = 5 \space million/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">200</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">5</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p><strong>What would be Requests Per Second (RPS) for our system?</strong></p><p>1 billion requests per day translate into 12K requests per second.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mn>1</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mrow><mo stretchy="false">(</mo><mn>24</mn><mtext> </mtext><mi>h</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>3600</mn><mtext> </mtext><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mi>s</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo>∼</mo><mn>12</mn><mi>K</mi><mtext> </mtext><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">\frac{1 \space billion}{(24 \space hrs \times 3600 \space seconds)} = \sim 12K \space requests/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3074em;vertical-align:-0.936em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">24</span><span class="mspace"> </span><span class="mord mathnormal">h</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">3600</span><span class="mspace"> </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">12</span><span class="mord mathnormal" style="margin-right:0.07153em">K</span><span class="mspace"> </span><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="storage-3">Storage<a href="#storage-3" class="hash-link" aria-label="Direct link to Storage" title="Direct link to Storage">​</a></h4><p>If we assume each video is 100 MB on average, we will require about 500 TB of storage every day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>5</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>100</mn><mtext> </mtext><mi>M</mi><mi>B</mi><mo>=</mo><mn>500</mn><mtext> </mtext><mi>T</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">5 \space million \times 100 \space MB = 500 \space TB/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">5</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">MB</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">500</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p>And for 10 years, we will require an astounding 1,825 PB of storage.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>500</mn><mtext> </mtext><mi>T</mi><mi>B</mi><mo>×</mo><mn>365</mn><mtext> </mtext><mi>d</mi><mi>a</mi><mi>y</mi><mi>s</mi><mo>×</mo><mn>10</mn><mtext> </mtext><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mi>s</mi><mo>=</mo><mo>∼</mo><mn>1</mn><mo separator="true">,</mo><mn>825</mn><mtext> </mtext><mi>P</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">500 \space TB \times 365 \space days \times 10 \space years = \sim 1,825 \space PB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord">500</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">365</span><span class="mspace"> </span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">ys</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">10</span><span class="mspace"> </span><span class="mord mathnormal">ye</span><span class="mord mathnormal">a</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">825</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">PB</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bandwidth-3">Bandwidth<a href="#bandwidth-3" class="hash-link" aria-label="Direct link to Bandwidth" title="Direct link to Bandwidth">​</a></h4><p>As our system is handling 500 TB of ingress every day, we will require a minimum bandwidth of around 5.8 GB per second.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mn>500</mn><mtext> </mtext><mi>T</mi><mi>B</mi></mrow><mrow><mo stretchy="false">(</mo><mn>24</mn><mtext> </mtext><mi>h</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>3600</mn><mtext> </mtext><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mi>s</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo>∼</mo><mn>5.8</mn><mtext> </mtext><mi>G</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">\frac{500 \space TB}{(24 \space hrs \times 3600 \space seconds)} = \sim 5.8 \space GB/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2963em;vertical-align:-0.936em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">24</span><span class="mspace"> </span><span class="mord mathnormal">h</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">3600</span><span class="mspace"> </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">500</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">TB</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">5.8</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">GB</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-estimate-3">High-level estimate<a href="#high-level-estimate-3" class="hash-link" aria-label="Direct link to High-level estimate" title="Direct link to High-level estimate">​</a></h4><p>Here is our high-level estimate:</p><table><thead><tr><th>Type</th><th>Estimate</th></tr></thead><tbody><tr><td>Daily active users (DAU)</td><td>200 million</td></tr><tr><td>Requests per second (RPS)</td><td>12K/s</td></tr><tr><td>Storage (per day)</td><td>~500 TB</td></tr><tr><td>Storage (10 years)</td><td>~1,825 PB</td></tr><tr><td>Bandwidth</td><td>~5.8 GB/s</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-model-design-4">Data model design<a href="#data-model-design-4" class="hash-link" aria-label="Direct link to Data model design" title="Direct link to Data model design">​</a></h3><p>This is the general data model which reflects our requirements.</p><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/netflix/netflix-datamodel.png" alt="netflix-datamodel" class="img_ev3q"></p><p>We have the following tables:</p><p><strong>users</strong></p><p>This table will contain a user&#x27;s information such as <code>name</code>, <code>email</code>, <code>dob</code>, and other details.</p><p><strong>videos</strong></p><p>As the name suggests, this table will store videos and their properties such as <code>title</code>, <code>streamURL</code>, <code>tags</code>, etc. We will also store the corresponding <code>userID</code>.</p><p><strong>tags</strong></p><p>This table will simply store tags associated with a video.</p><p><strong>views</strong></p><p>This table helps us to store all the views received on a video.</p><p><strong>comments</strong></p><p>This table stores all the comments received on a video (like YouTube).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-kind-of-database-should-we-use-3">What kind of database should we use?<a href="#what-kind-of-database-should-we-use-3" class="hash-link" aria-label="Direct link to What kind of database should we use?" title="Direct link to What kind of database should we use?">​</a></h4><p>While our data model seems quite relational, we don&#x27;t necessarily need to store everything in a single database, as this can limit our scalability and quickly become a bottleneck.</p><p>We will split the data between different services each having ownership over a particular table. Then we can use a relational database such as <a href="https://www.postgresql.org" target="_blank" rel="noopener noreferrer">PostgreSQL</a> or a distributed NoSQL database such as <a href="https://cassandra.apache.org/_/index.html" target="_blank" rel="noopener noreferrer">Apache Cassandra</a> for our use case.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-design-4">API design<a href="#api-design-4" class="hash-link" aria-label="Direct link to API design" title="Direct link to API design">​</a></h3><p>Let us do a basic API design for our services:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="upload-a-video">Upload a video<a href="#upload-a-video" class="hash-link" aria-label="Direct link to Upload a video" title="Direct link to Upload a video">​</a></h4><p>Given a byte stream, this API enables video to be uploaded to our service.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">uploadVideo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Stream</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">byte</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tags</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>Title (<code>string</code>): Title of the new video.</p><p>Description (<code>string</code>): Description of the new video.</p><p>Data (<code>Byte[]</code>): Byte stream of the video data.</p><p>Tags (<code>string[]</code>): Tags for the video <em>(optional)</em>.</p><p><strong>Returns</strong></p><p>Result (<code>boolean</code>): Represents whether the operation was successful or not.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="streaming-a-video">Streaming a video<a href="#streaming-a-video" class="hash-link" aria-label="Direct link to Streaming a video" title="Direct link to Streaming a video">​</a></h4><p>This API allows our users to stream a video with the preferred codec and resolution.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">streamVideo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">videoID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> codec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Enum</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resolution</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Tuple</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">int</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> offset</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">VideoStream</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>Video ID (<code>UUID</code>): ID of the video that needs to be streamed.</p><p>Codec (<code>Enum&lt;string&gt;</code>): Required <a href="https://en.wikipedia.org/wiki/Video_codec" target="_blank" rel="noopener noreferrer">codec</a> of the requested video, such as <code>h.265</code>, <code>h.264</code>, <code>VP9</code>, etc.</p><p>Resolution (<code>Tuple&lt;int&gt;</code>): <a href="https://en.wikipedia.org/wiki/Display_resolution" target="_blank" rel="noopener noreferrer">Resolution</a> of the requested video.</p><p>Offset (<code>int</code>): Offset of the video stream in seconds to stream data from any point in the video <em>(optional)</em>.</p><p><strong>Returns</strong></p><p>Stream (<code>VideoStream</code>): Data stream of the requested video.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="search-for-a-video">Search for a video<a href="#search-for-a-video" class="hash-link" aria-label="Direct link to Search for a video" title="Direct link to Search for a video">​</a></h4><p>This API will enable our users to search for a video based on its title or tags.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">searchVideo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextPage</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Video</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>Query (<code>string</code>): Search query from the user.</p><p>Next Page (<code>string</code>): Token for the next page, this can be used for pagination <em>(optional)</em>.</p><p><strong>Returns</strong></p><p>Videos (<code>Video[]</code>): All the videos available for a particular search query.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="add-a-comment">Add a comment<a href="#add-a-comment" class="hash-link" aria-label="Direct link to Add a comment" title="Direct link to Add a comment">​</a></h4><p>This API will allow our users to post a comment on a video (like YouTube).</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">comment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">videoID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> comment</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>VideoID (<code>UUID</code>): ID of the video user wants to comment on.</p><p>Comment (<code>string</code>): The text content of the comment.</p><p><strong>Returns</strong></p><p>Result (<code>boolean</code>): Represents whether the operation was successful or not.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-design-3">High-level design<a href="#high-level-design-3" class="hash-link" aria-label="Direct link to High-level design" title="Direct link to High-level design">​</a></h3><p>Now let us do a high-level design of our system.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-2">Architecture<a href="#architecture-2" class="hash-link" aria-label="Direct link to Architecture" title="Direct link to Architecture">​</a></h4><p>We will be using <a href="https://karanpratapsingh.com/courses/system-design/monoliths-microservices#microservices" target="_blank" rel="noopener noreferrer">microservices architecture</a> since it will make it easier to horizontally scale and decouple our services. Each service will have ownership of its own data model. Let&#x27;s try to divide our system into some core services.</p><p><strong>User Service</strong></p><p>This service handles user-related concerns such as authentication and user information.</p><p><strong>Stream Service</strong></p><p>The stream service will handle video streaming-related functionality.</p><p><strong>Search Service</strong></p><p>The service is responsible for handling search-related functionality. It will be discussed in detail separately.</p><p><strong>Media service</strong></p><p>This service will handle the video uploads and processing. It will be discussed in detail separately.</p><p><strong>Analytics Service</strong></p><p>This service will be used for metrics and analytics use cases.</p><p><strong>What about inter-service communication and service discovery?</strong></p><p>Since our architecture is microservices-based, services will be communicating with each other as well. Generally, REST or HTTP performs well but we can further improve the performance using <a href="https://karanpratapsingh.com/courses/system-design/rest-graphql-grpc#grpc" target="_blank" rel="noopener noreferrer">gRPC</a> which is more lightweight and efficient.</p><p><a href="https://karanpratapsingh.com/courses/system-design/service-discovery" target="_blank" rel="noopener noreferrer">Service discovery</a> is another thing we will have to take into account. We can also use a service mesh that enables managed, observable, and secure communication between individual services.</p><p><em>Note: Learn more about <a href="https://karanpratapsingh.com/courses/system-design/rest-graphql-grpc" target="_blank" rel="noopener noreferrer">REST, GraphQL, gRPC</a> and how they compare with each other.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="video-processing">Video processing<a href="#video-processing" class="hash-link" aria-label="Direct link to Video processing" title="Direct link to Video processing">​</a></h4><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/netflix/video-processing-pipeline.png" alt="video-processing-pipeline" class="img_ev3q"></p><p>There are so many variables in play when it comes to processing a video. For example, an average data size of two-hour raw 8K footage from a high-end camera can easily be up to 4 TB, thus we need to have some kind of processing to reduce both storage and delivery costs.</p><p>Here&#x27;s how we can process videos once they&#x27;re uploaded by the content team (or users in YouTube&#x27;s case) and are queued for processing in our <a href="https://karanpratapsingh.com/courses/system-design/message-queues" target="_blank" rel="noopener noreferrer">message queue</a>.</p><p>Let&#x27;s discuss how this works:</p><ul><li><strong>File Chunker</strong></li></ul><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/netflix/file-chunking.png" alt="file-chunking" class="img_ev3q"></p><p>This is the first step of our processing pipeline. File chunking is the process of splitting a file into smaller pieces called chunks. It can help us eliminate duplicate copies of repeating data on storage, and reduces the amount of data sent over the network by only selecting changed chunks.</p><p>Usually, a video file can be split into equal size chunks based on timestamps but Netflix instead splits chunks based on scenes. This slight variation becomes a huge factor for a better user experience since whenever the client requests a chunk from the server, there is a lower chance of interruption as a complete scene will be retrieved.</p><ul><li><strong>Content Filter</strong></li></ul><p>This step checks if the video adheres to the content policy of the platform. This can be pre-approved as in the case of Netflix according to <a href="https://en.wikipedia.org/wiki/Motion_picture_content_rating_system" target="_blank" rel="noopener noreferrer">content rating</a> of the media or can be strictly enforced like by YouTube.</p><p>This entire process is done by a machine learning model which performs copyright, piracy, and NSFW checks. If issues are found, we can push the task to a <a href="https://karanpratapsingh.com/courses/system-design/message-queues#dead-letter-queues" target="_blank" rel="noopener noreferrer">dead-letter queue (DLQ)</a> and someone from the moderation team can do further inspection.</p><ul><li><strong>Transcoder</strong></li></ul><p><a href="https://en.wikipedia.org/wiki/Transcoding" target="_blank" rel="noopener noreferrer">Transcoding</a> is a process in which the original data is decoded to an intermediate uncompressed format, which is then encoded into the target format. This process uses different <a href="https://en.wikipedia.org/wiki/Video_codec" target="_blank" rel="noopener noreferrer">codecs</a> to perform bitrate adjustment, image downsampling, or re-encoding the media.</p><p>This results in a smaller size file and a much more optimized format for the target devices. Standalone solutions such as <a href="https://ffmpeg.org" target="_blank" rel="noopener noreferrer">FFmpeg</a> or cloud-based solutions like <a href="https://aws.amazon.com/mediaconvert" target="_blank" rel="noopener noreferrer">AWS Elemental MediaConvert</a> can be used to implement this step of the pipeline.</p><ul><li><strong>Quality Conversion</strong></li></ul><p>This is the last step of the processing pipeline and as the name suggests, this step handles the conversion of the transcoded media from the previous step into different resolutions such as 4K, 1440p, 1080p, 720p, etc.</p><p>It allows us to fetch the desired quality of the video as per the user&#x27;s request, and once the media file finishes processing, it gets uploaded to a distributed file storage such as <a href="https://karanpratapsingh.com/courses/system-design/storage#hdfs" target="_blank" rel="noopener noreferrer">HDFS</a>, <a href="https://www.gluster.org" target="_blank" rel="noopener noreferrer">GlusterFS</a>, or an <a href="https://karanpratapsingh.com/courses/system-design/storage#object-storage" target="_blank" rel="noopener noreferrer">object storage</a> such as <a href="https://aws.amazon.com/s3" target="_blank" rel="noopener noreferrer">Amazon S3</a> for later retrieval during streaming.</p><p><em>Note: We can add additional steps such as subtitles and thumbnails generation as part of our pipeline.</em></p><p><strong>Why are we using a message queue?</strong></p><p>Processing videos as a long-running task and using a <a href="https://karanpratapsingh.com/courses/system-design/message-queues" target="_blank" rel="noopener noreferrer">message queue</a> makes much more sense. It also decouples our video processing pipeline from the upload functionality. We can use something like <a href="https://aws.amazon.com/sqs" target="_blank" rel="noopener noreferrer">Amazon SQS</a> or <a href="https://www.rabbitmq.com" target="_blank" rel="noopener noreferrer">RabbitMQ</a> to support this.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="video-streaming">Video streaming<a href="#video-streaming" class="hash-link" aria-label="Direct link to Video streaming" title="Direct link to Video streaming">​</a></h4><p>Video streaming is a challenging task from both the client and server perspectives. Moreover, internet connection speeds vary quite a lot between different users. To make sure users don&#x27;t re-fetch the same content, we can use a <a href="https://karanpratapsingh.com/courses/system-design/content-delivery-network" target="_blank" rel="noopener noreferrer">Content Delivery Network (CDN)</a>.</p><p>Netflix takes this a step further with its <a href="https://openconnect.netflix.com" target="_blank" rel="noopener noreferrer">Open Connect</a> program. In this approach, they partner with thousands of Internet Service Providers (ISPs) to localize their traffic and deliver their content more efficiently.</p><p><strong>What is the difference between Netflix&#x27;s Open Connect and a traditional Content Delivery Network (CDN)?</strong></p><p>Netflix Open Connect is a purpose-built <a href="https://karanpratapsingh.com/courses/system-design/content-delivery-network" target="_blank" rel="noopener noreferrer">Content Delivery Network (CDN)</a> responsible for serving Netflix&#x27;s video traffic. Around 95% of the traffic globally is delivered via direct connections between Open Connect and the ISPs their customers use to access the internet.</p><p>Currently, they have Open Connect Appliances (OCAs) in over 1000 separate locations around the world. In case of issues, Open Connect Appliances (OCAs) can failover, and the traffic can be re-routed to Netflix servers.</p><p>Additionally, we can use <a href="https://en.wikipedia.org/wiki/Adaptive_bitrate_streaming" target="_blank" rel="noopener noreferrer">Adaptive bitrate streaming</a> protocols such as <a href="https://en.wikipedia.org/wiki/HTTP_Live_Streaming" target="_blank" rel="noopener noreferrer">HTTP Live Streaming (HLS)</a> which is designed for reliability and it dynamically adapts to network conditions by optimizing playback for the available speed of the connections.</p><p>Lastly, for playing the video from where the user left off (part of our extended requirements), we can simply use the <code>offset</code> property we stored in the <code>views</code> table to retrieve the scene chunk at that particular timestamp and resume the playback for the user.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="searching">Searching<a href="#searching" class="hash-link" aria-label="Direct link to Searching" title="Direct link to Searching">​</a></h4><p>Sometimes traditional DBMS are not performant enough, we need something which allows us to store, search, and analyze huge volumes of data quickly and in near real-time and give results within milliseconds. <a href="https://www.elastic.co" target="_blank" rel="noopener noreferrer">Elasticsearch</a> can help us with this use case.</p><p><a href="https://www.elastic.co" target="_blank" rel="noopener noreferrer">Elasticsearch</a> is a distributed, free and open search and analytics engine for all types of data, including textual, numerical, geospatial, structured, and unstructured. It is built on top of <a href="https://lucene.apache.org" target="_blank" rel="noopener noreferrer">Apache Lucene</a>.</p><p><strong>How do we identify trending content?</strong></p><p>Trending functionality will be based on top of the search functionality. We can cache the most frequently searched queries in the last <code>N</code> seconds and update them every <code>M</code> seconds using some sort of batch job mechanism.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="sharing">Sharing<a href="#sharing" class="hash-link" aria-label="Direct link to Sharing" title="Direct link to Sharing">​</a></h4><p>Sharing content is an important part of any platform, for this, we can have some sort of URL shortener service in place that can generate short URLs for the users to share.</p><p><em>For more details, refer to the <a href="https://karanpratapsingh.com/courses/system-design/url-shortener" target="_blank" rel="noopener noreferrer">URL Shortener</a> system design.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="detailed-design-4">Detailed design<a href="#detailed-design-4" class="hash-link" aria-label="Direct link to Detailed design" title="Direct link to Detailed design">​</a></h3><p>It&#x27;s time to discuss our design decisions in detail.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="data-partitioning-3">Data Partitioning<a href="#data-partitioning-3" class="hash-link" aria-label="Direct link to Data Partitioning" title="Direct link to Data Partitioning">​</a></h4><p>To scale out our databases we will need to partition our data. Horizontal partitioning (aka <a href="https://karanpratapsingh.com/courses/system-design/sharding" target="_blank" rel="noopener noreferrer">Sharding</a>) can be a good first step. We can use partitions schemes such as:</p><ul><li>Hash-Based Partitioning</li><li>List-Based Partitioning</li><li>Range Based Partitioning</li><li>Composite Partitioning</li></ul><p>The above approaches can still cause uneven data and load distribution, we can solve this using <a href="https://karanpratapsingh.com/courses/system-design/consistent-hashing" target="_blank" rel="noopener noreferrer">Consistent hashing</a>.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/sharding" target="_blank" rel="noopener noreferrer">Sharding</a> and <a href="https://karanpratapsingh.com/courses/system-design/consistent-hashing" target="_blank" rel="noopener noreferrer">Consistent Hashing</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="geo-blocking">Geo-blocking<a href="#geo-blocking" class="hash-link" aria-label="Direct link to Geo-blocking" title="Direct link to Geo-blocking">​</a></h4><p>Platforms like Netflix and YouTube use <a href="https://en.wikipedia.org/wiki/Geo-blocking" target="_blank" rel="noopener noreferrer">Geo-blocking</a> to restrict content in certain geographical areas or countries. This is primarily done due to legal distribution laws that Netflix has to adhere to when they make a deal with the production and distribution companies. In the case of YouTube, this will be controlled by the user during the publishing of the content.</p><p>We can determine the user&#x27;s location either using their <a href="https://karanpratapsingh.com/courses/system-design/ip" target="_blank" rel="noopener noreferrer">IP</a> or region settings in their profile then use services like <a href="https://aws.amazon.com/cloudfront" target="_blank" rel="noopener noreferrer">Amazon CloudFront</a> which supports a geographic restrictions feature or a <a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-policy-geo.html" target="_blank" rel="noopener noreferrer">geolocation routing policy</a> with <a href="https://aws.amazon.com/route53" target="_blank" rel="noopener noreferrer">Amazon Route53</a> to restrict the content and re-route the user to an error page if the content is not available in that particular region or country.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="recommendations">Recommendations<a href="#recommendations" class="hash-link" aria-label="Direct link to Recommendations" title="Direct link to Recommendations">​</a></h4><p>Netflix uses a machine learning model which uses the user&#x27;s viewing history to predict what the user might like to watch next, an algorithm like <a href="https://en.wikipedia.org/wiki/Collaborative_filtering" target="_blank" rel="noopener noreferrer">Collaborative Filtering</a> can be used.</p><p>However, Netflix (like YouTube) uses its own algorithm called Netflix Recommendation Engine which can track several data points such as:</p><ul><li>User profile information like age, gender, and location.</li><li>Browsing and scrolling behavior of the user.</li><li>Time and date a user watched a title.</li><li>The device which was used to stream the content.</li><li>The number of searches and what terms were searched.</li></ul><p><em>For more detail, refer to <a href="https://research.netflix.com/research-area/recommendations" target="_blank" rel="noopener noreferrer">Netflix recommendation research</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics-and-analytics-2">Metrics and Analytics<a href="#metrics-and-analytics-2" class="hash-link" aria-label="Direct link to Metrics and Analytics" title="Direct link to Metrics and Analytics">​</a></h4><p>Recording analytics and metrics is one of our extended requirements. We can capture the data from different services and run analytics on the data using <a href="https://spark.apache.org" target="_blank" rel="noopener noreferrer">Apache Spark</a> which is an open-source unified analytics engine for large-scale data processing. Additionally, we can store critical metadata in the views table to increase data points within our data.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="caching-3">Caching<a href="#caching-3" class="hash-link" aria-label="Direct link to Caching" title="Direct link to Caching">​</a></h4><p>In a streaming platform, caching is important. We have to be able to cache as much static media content as possible to improve user experience. We can use solutions like <a href="https://redis.io" target="_blank" rel="noopener noreferrer">Redis</a> or <a href="https://memcached.org" target="_blank" rel="noopener noreferrer">Memcached</a> but what kind of cache eviction policy would best fit our needs?</p><p><strong>Which cache eviction policy to use?</strong></p><p><a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_(LRU)" target="_blank" rel="noopener noreferrer">Least Recently Used (LRU)</a> can be a good policy for our system. In this policy, we discard the least recently used key first.</p><p><strong>How to handle cache miss?</strong></p><p>Whenever there is a cache miss, our servers can hit the database directly and update the cache with the new entries.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/caching" target="_blank" rel="noopener noreferrer">Caching</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="media-streaming-and-storage">Media streaming and storage<a href="#media-streaming-and-storage" class="hash-link" aria-label="Direct link to Media streaming and storage" title="Direct link to Media streaming and storage">​</a></h4><p>As most of our storage space will be used for storing media files such as thumbnails and videos. Per our discussion earlier, the media service will be handling both the upload and processing of media files.</p><p>We will use distributed file storage such as <a href="https://karanpratapsingh.com/courses/system-design/storage#hdfs" target="_blank" rel="noopener noreferrer">HDFS</a>, <a href="https://www.gluster.org" target="_blank" rel="noopener noreferrer">GlusterFS</a>, or an <a href="https://karanpratapsingh.com/courses/system-design/storage#object-storage" target="_blank" rel="noopener noreferrer">object storage</a> such as <a href="https://aws.amazon.com/s3" target="_blank" rel="noopener noreferrer">Amazon S3</a> for storage and streaming of the content.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="content-delivery-network-cdn-2">Content Delivery Network (CDN)<a href="#content-delivery-network-cdn-2" class="hash-link" aria-label="Direct link to Content Delivery Network (CDN)" title="Direct link to Content Delivery Network (CDN)">​</a></h4><p><a href="https://karanpratapsingh.com/courses/system-design/content-delivery-network" target="_blank" rel="noopener noreferrer">Content Delivery Network (CDN)</a> increases content availability and redundancy while reducing bandwidth costs. Generally, static files such as images, and videos are served from CDN. We can use services like <a href="https://aws.amazon.com/cloudfront" target="_blank" rel="noopener noreferrer">Amazon CloudFront</a> or <a href="https://www.cloudflare.com/cdn" target="_blank" rel="noopener noreferrer">Cloudflare CDN</a> for this use case.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="identify-and-resolve-bottlenecks-4">Identify and resolve bottlenecks<a href="#identify-and-resolve-bottlenecks-4" class="hash-link" aria-label="Direct link to Identify and resolve bottlenecks" title="Direct link to Identify and resolve bottlenecks">​</a></h3><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/netflix/netflix-advanced-design.png" alt="netflix-advanced-design" class="img_ev3q"></p><p>Let us identify and resolve bottlenecks such as single points of failure in our design:</p><ul><li>&quot;What if one of our services crashes?&quot;</li><li>&quot;How will we distribute our traffic between our components?&quot;</li><li>&quot;How can we reduce the load on our database?&quot;</li><li>&quot;How to improve the availability of our cache?&quot;</li></ul><p>To make our system more resilient we can do the following:</p><ul><li>Running multiple instances of each of our services.</li><li>Introducing <a href="https://karanpratapsingh.com/courses/system-design/load-balancing" target="_blank" rel="noopener noreferrer">load balancers</a> between clients, servers, databases, and cache servers.</li><li>Using multiple read replicas for our databases.</li><li>Multiple instances and replicas for our distributed cache.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="uber">Uber<a href="#uber" class="hash-link" aria-label="Direct link to Uber" title="Direct link to Uber">​</a></h2><p>Let&#x27;s design an <a href="https://uber.com" target="_blank" rel="noopener noreferrer">Uber</a> like ride-hailing service, similar to services like <a href="https://www.lyft.com" target="_blank" rel="noopener noreferrer">Lyft</a>, <a href="https://www.olacabs.com" target="_blank" rel="noopener noreferrer">OLA Cabs</a>, etc.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-uber">What is Uber?<a href="#what-is-uber" class="hash-link" aria-label="Direct link to What is Uber?" title="Direct link to What is Uber?">​</a></h3><p>Uber is a mobility service provider, allowing users to book rides and a driver to transport them in a way similar to a taxi. It is available on the web and mobile platforms such as Android and iOS.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="requirements-4">Requirements<a href="#requirements-4" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements">​</a></h3><p>Our system should meet the following requirements:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="functional-requirements-5">Functional requirements<a href="#functional-requirements-5" class="hash-link" aria-label="Direct link to Functional requirements" title="Direct link to Functional requirements">​</a></h4><p>We will design our system for two types of users: Customers and Drivers.</p><p><strong>Customers</strong></p><ul><li>Customers should be able to see all the cabs in the vicinity with an ETA and pricing information.</li><li>Customers should be able to book a cab to a destination.</li><li>Customers should be able to see the location of the driver.</li></ul><p><strong>Drivers</strong></p><ul><li>Drivers should be able to accept or deny the customer-requested ride.</li><li>Once a driver accepts the ride, they should see the pickup location of the customer.</li><li>Drivers should be able to mark the trip as complete on reaching the destination.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="non-functional-requirements-5">Non-Functional requirements<a href="#non-functional-requirements-5" class="hash-link" aria-label="Direct link to Non-Functional requirements" title="Direct link to Non-Functional requirements">​</a></h4><ul><li>High reliability.</li><li>High availability with minimal latency.</li><li>The system should be scalable and efficient.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="extended-requirements-5">Extended requirements<a href="#extended-requirements-5" class="hash-link" aria-label="Direct link to Extended requirements" title="Direct link to Extended requirements">​</a></h4><ul><li>Customers can rate the trip after it&#x27;s completed.</li><li>Payment processing.</li><li>Metrics and analytics.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="estimation-and-constraints-5">Estimation and Constraints<a href="#estimation-and-constraints-5" class="hash-link" aria-label="Direct link to Estimation and Constraints" title="Direct link to Estimation and Constraints">​</a></h3><p>Let&#x27;s start with the estimation and constraints.</p><p><em>Note: Make sure to check any scale or traffic-related assumptions with your interviewer.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="traffic-4">Traffic<a href="#traffic-4" class="hash-link" aria-label="Direct link to Traffic" title="Direct link to Traffic">​</a></h4><p>Let us assume we have 100 million daily active users (DAU) with 1 million drivers and on average our platform enables 10 million rides daily.</p><p>If on average each user performs 10 actions (such as request a check available rides, fares, book rides, etc.) we will have to handle 1 billion requests daily.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>100</mn><mtext> </mtext><mi>m</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>10</mn><mtext> </mtext><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>s</mi><mo>=</mo><mn>1</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">100 \space million \times 10 \space actions = 1 \space billion/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">100</span><span class="mspace"> </span><span class="mord mathnormal">mi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord">10</span><span class="mspace"> </span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p><strong>What would be Requests Per Second (RPS) for our system?</strong></p><p>1 billion requests per day translate into 12K requests per second.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mn>1</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mrow><mo stretchy="false">(</mo><mn>24</mn><mtext> </mtext><mi>h</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>3600</mn><mtext> </mtext><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mi>s</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo>∼</mo><mn>12</mn><mi>K</mi><mtext> </mtext><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">\frac{1 \space billion}{(24 \space hrs \times 3600 \space seconds)} = \sim 12K \space requests/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3074em;vertical-align:-0.936em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">24</span><span class="mspace"> </span><span class="mord mathnormal">h</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">3600</span><span class="mspace"> </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">12</span><span class="mord mathnormal" style="margin-right:0.07153em">K</span><span class="mspace"> </span><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="storage-4">Storage<a href="#storage-4" class="hash-link" aria-label="Direct link to Storage" title="Direct link to Storage">​</a></h4><p>If we assume each message on average is 400 bytes, we will require about 400 GB of database storage every day.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>1</mn><mtext> </mtext><mi>b</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>×</mo><mn>400</mn><mtext> </mtext><mi>b</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mo>=</mo><mo>∼</mo><mn>400</mn><mtext> </mtext><mi>G</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>a</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">1 \space billion \times 400 \space bytes = \sim 400 \space GB/day</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">400</span><span class="mspace"> </span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mord mathnormal">t</span><span class="mord mathnormal">es</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">400</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">GB</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></span></div><p>And for 10 years, we will require about 1.4 PB of storage.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>400</mn><mtext> </mtext><mi>G</mi><mi>B</mi><mo>×</mo><mn>10</mn><mtext> </mtext><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>365</mn><mtext> </mtext><mi>d</mi><mi>a</mi><mi>y</mi><mi>s</mi><mo>=</mo><mo>∼</mo><mn>1.4</mn><mtext> </mtext><mi>P</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">400 \space GB \times 10 \space years \times 365 \space days = \sim 1.4 \space PB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord">400</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">GB</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">10</span><span class="mspace"> </span><span class="mord mathnormal">ye</span><span class="mord mathnormal">a</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">365</span><span class="mspace"> </span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">ys</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">1.4</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">PB</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bandwidth-4">Bandwidth<a href="#bandwidth-4" class="hash-link" aria-label="Direct link to Bandwidth" title="Direct link to Bandwidth">​</a></h4><p>As our system is handling 400 GB of ingress every day, we will require a minimum bandwidth of around 4 MB per second.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mn>400</mn><mtext> </mtext><mi>G</mi><mi>B</mi></mrow><mrow><mo stretchy="false">(</mo><mn>24</mn><mtext> </mtext><mi>h</mi><mi>r</mi><mi>s</mi><mo>×</mo><mn>3600</mn><mtext> </mtext><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mi>s</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo>∼</mo><mn>5</mn><mtext> </mtext><mi>M</mi><mi>B</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">\frac{400 \space GB}{(24 \space hrs \times 3600 \space seconds)} = \sim 5 \space MB/second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2963em;vertical-align:-0.936em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">24</span><span class="mspace"> </span><span class="mord mathnormal">h</span><span class="mord mathnormal">rs</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">3600</span><span class="mspace"> </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">400</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">GB</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=∼</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">5</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em">MB</span><span class="mord">/</span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-estimate-4">High-level estimate<a href="#high-level-estimate-4" class="hash-link" aria-label="Direct link to High-level estimate" title="Direct link to High-level estimate">​</a></h4><p>Here is our high-level estimate:</p><table><thead><tr><th>Type</th><th>Estimate</th></tr></thead><tbody><tr><td>Daily active users (DAU)</td><td>100 million</td></tr><tr><td>Requests per second (RPS)</td><td>12K/s</td></tr><tr><td>Storage (per day)</td><td>~400 GB</td></tr><tr><td>Storage (10 years)</td><td>~1.4 PB</td></tr><tr><td>Bandwidth</td><td>~5 MB/s</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-model-design-5">Data model design<a href="#data-model-design-5" class="hash-link" aria-label="Direct link to Data model design" title="Direct link to Data model design">​</a></h3><p>This is the general data model which reflects our requirements.</p><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/uber/uber-datamodel.png" alt="uber-datamodel" class="img_ev3q"></p><p>We have the following tables:</p><p><strong>customers</strong></p><p>This table will contain a customer&#x27;s information such as <code>name</code>, <code>email</code>, and other details.</p><p><strong>drivers</strong></p><p>This table will contain a driver&#x27;s information such as <code>name</code>, <code>email</code>, <code>dob</code> and other details.</p><p><strong>trips</strong></p><p>This table represents the trip taken by the customer and stores data such as <code>source</code>, <code>destination</code>, and <code>status</code> of the trip.</p><p><strong>cabs</strong></p><p>This table stores data such as the registration number, and type (like Uber Go, Uber XL, etc.) of the cab that the driver will be driving.</p><p><strong>ratings</strong></p><p>As the name suggests, this table stores the <code>rating</code> and <code>feedback</code> for the trip.</p><p><strong>payments</strong></p><p>The payments table contains the payment-related data with the corresponding <code>tripID</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-kind-of-database-should-we-use-4">What kind of database should we use?<a href="#what-kind-of-database-should-we-use-4" class="hash-link" aria-label="Direct link to What kind of database should we use?" title="Direct link to What kind of database should we use?">​</a></h4><p>While our data model seems quite relational, we don&#x27;t necessarily need to store everything in a single database, as this can limit our scalability and quickly become a bottleneck.</p><p>We will split the data between different services each having ownership over a particular table. Then we can use a relational database such as <a href="https://www.postgresql.org" target="_blank" rel="noopener noreferrer">PostgreSQL</a> or a distributed NoSQL database such as <a href="https://cassandra.apache.org/_/index.html" target="_blank" rel="noopener noreferrer">Apache Cassandra</a> for our use case.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-design-5">API design<a href="#api-design-5" class="hash-link" aria-label="Direct link to API design" title="Direct link to API design">​</a></h3><p>Let us do a basic API design for our services:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="request-a-ride">Request a Ride<a href="#request-a-ride" class="hash-link" aria-label="Direct link to Request a Ride" title="Direct link to Request a Ride">​</a></h4><p>Through this API, customers will be able to request a ride.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">requestRide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customerID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> source</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Tuple</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">float</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> destination</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Tuple</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">float</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cabType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Enum</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> paymentMethod</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Enum</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Ride</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>Customer ID (<code>UUID</code>): ID of the customer.</p><p>Source (<code>Tuple&lt;float&gt;</code>): Tuple containing the latitude and longitude of the trip&#x27;s starting location.</p><p>Destination (<code>Tuple&lt;float&gt;</code>): Tuple containing the latitude and longitude of the trip&#x27;s destination.</p><p><strong>Returns</strong></p><p>Result (<code>Ride</code>): Associated ride information of the trip.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cancel-the-ride">Cancel the Ride<a href="#cancel-the-ride" class="hash-link" aria-label="Direct link to Cancel the Ride" title="Direct link to Cancel the Ride">​</a></h4><p>This API will allow customers to cancel the ride.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cancelRide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customerID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>Customer ID (<code>UUID</code>): ID of the customer.</p><p>Reason (<code>UUID</code>): Reason for canceling the ride <em>(optional)</em>.</p><p><strong>Returns</strong></p><p>Result (<code>boolean</code>): Represents whether the operation was successful or not.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="accept-or-deny-the-ride">Accept or Deny the Ride<a href="#accept-or-deny-the-ride" class="hash-link" aria-label="Direct link to Accept or Deny the Ride" title="Direct link to Accept or Deny the Ride">​</a></h4><p>This API will allow the driver to accept or deny the trip.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">acceptRide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">driverID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rideID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">denyRide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">driverID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rideID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>Driver ID (<code>UUID</code>): ID of the driver.</p><p>Ride ID (<code>UUID</code>): ID of the customer requested ride.</p><p><strong>Returns</strong></p><p>Result (<code>boolean</code>): Represents whether the operation was successful or not.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="start-or-end-the-trip">Start or End the Trip<a href="#start-or-end-the-trip" class="hash-link" aria-label="Direct link to Start or End the Trip" title="Direct link to Start or End the Trip">​</a></h4><p>Using this API, a driver will be able to start and end the trip.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">startTrip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">driverID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tripID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">endTrip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">driverID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tripID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>Driver ID (<code>UUID</code>): ID of the driver.</p><p>Trip ID (<code>UUID</code>): ID of the requested trip.</p><p><strong>Returns</strong></p><p>Result (<code>boolean</code>): Represents whether the operation was successful or not.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rate-the-trip">Rate the Trip<a href="#rate-the-trip" class="hash-link" aria-label="Direct link to Rate the Trip" title="Direct link to Rate the Trip">​</a></h4><p>This API will enable customers to rate the trip.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">rateTrip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customerID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tripID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rating</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> feedback</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Parameters</strong></p><p>Customer ID (<code>UUID</code>): ID of the customer.</p><p>Trip ID (<code>UUID</code>): ID of the completed trip.</p><p>Rating (<code>int</code>): Rating of the trip.</p><p>Feedback (<code>string</code>): Feedback about the trip by the customer <em>(optional)</em>.</p><p><strong>Returns</strong></p><p>Result (<code>boolean</code>): Represents whether the operation was successful or not.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-design-4">High-level design<a href="#high-level-design-4" class="hash-link" aria-label="Direct link to High-level design" title="Direct link to High-level design">​</a></h3><p>Now let us do a high-level design of our system.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-3">Architecture<a href="#architecture-3" class="hash-link" aria-label="Direct link to Architecture" title="Direct link to Architecture">​</a></h4><p>We will be using <a href="https://karanpratapsingh.com/courses/system-design/monoliths-microservices#microservices" target="_blank" rel="noopener noreferrer">microservices architecture</a> since it will make it easier to horizontally scale and decouple our services. Each service will have ownership of its own data model. Let&#x27;s try to divide our system into some core services.</p><p><strong>Customer Service</strong></p><p>This service handles customer-related concerns such as authentication and customer information.</p><p><strong>Driver Service</strong></p><p>This service handles driver-related concerns such as authentication and driver information.</p><p><strong>Ride Service</strong></p><p>This service will be responsible for ride matching and quadtree aggregation. It will be discussed in detail separately.</p><p><strong>Trip Service</strong></p><p>This service handles trip-related functionality in our system.</p><p><strong>Payment Service</strong></p><p>This service will be responsible for handling payments in our system.</p><p><strong>Notification Service</strong></p><p>This service will simply send push notifications to the users. It will be discussed in detail separately.</p><p><strong>Analytics Service</strong></p><p>This service will be used for metrics and analytics use cases.</p><p><strong>What about inter-service communication and service discovery?</strong></p><p>Since our architecture is microservices-based, services will be communicating with each other as well. Generally, REST or HTTP performs well but we can further improve the performance using <a href="https://karanpratapsingh.com/courses/system-design/rest-graphql-grpc#grpc" target="_blank" rel="noopener noreferrer">gRPC</a> which is more lightweight and efficient.</p><p><a href="https://karanpratapsingh.com/courses/system-design/service-discovery" target="_blank" rel="noopener noreferrer">Service discovery</a> is another thing we will have to take into account. We can also use a service mesh that enables managed, observable, and secure communication between individual services.</p><p><em>Note: Learn more about <a href="https://karanpratapsingh.com/courses/system-design/rest-graphql-grpc" target="_blank" rel="noopener noreferrer">REST, GraphQL, gRPC</a> and how they compare with each other.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="how-is-the-service-expected-to-work">How is the service expected to work?<a href="#how-is-the-service-expected-to-work" class="hash-link" aria-label="Direct link to How is the service expected to work?" title="Direct link to How is the service expected to work?">​</a></h4><p>Here&#x27;s how our service is expected to work:</p><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/uber/uber-working.png" alt="uber-working" class="img_ev3q"></p><ol><li>Customer requests a ride by specifying the source, destination, cab type, payment method, etc.</li><li>Ride service registers this request, finds nearby drivers, and calculates the estimated time of arrival (ETA).</li><li>The request is then broadcasted to the nearby drivers for them to accept or deny.</li><li>If the driver accepts, the customer is notified about the live location of the driver with the estimated time of arrival (ETA) while they wait for pickup.</li><li>The customer is picked up and the driver can start the trip.</li><li>Once the destination is reached, the driver will mark the ride as complete and collect payment.</li><li>After the payment is complete, the customer can leave a rating and feedback for the trip if they like.</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="location-tracking">Location Tracking<a href="#location-tracking" class="hash-link" aria-label="Direct link to Location Tracking" title="Direct link to Location Tracking">​</a></h4><p>How do we efficiently send and receive live location data from the client (customers and drivers) to our backend? We have two different options:</p><p><strong>Pull model</strong></p><p>The client can periodically send an HTTP request to servers to report its current location and receive ETA and pricing information. This can be achieved via something like <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events#long-polling" target="_blank" rel="noopener noreferrer">Long polling</a>.</p><p><strong>Push model</strong></p><p>The client opens a long-lived connection with the server and once new data is available it will be pushed to the client. We can use <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events#websockets" target="_blank" rel="noopener noreferrer">WebSockets</a> or <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events#server-sent-events-sse" target="_blank" rel="noopener noreferrer">Server-Sent Events (SSE)</a> for this.</p><p>The pull model approach is not scalable as it will create unnecessary request overhead on our servers and most of the time the response will be empty, thus wasting our resources. To minimize latency, using the push model with <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events#websockets" target="_blank" rel="noopener noreferrer">WebSockets</a> is a better choice because then we can push data to the client once it&#x27;s available without any delay, given the connection is open with the client. Also, WebSockets provide full-duplex communication, unlike <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events#server-sent-events-sse" target="_blank" rel="noopener noreferrer">Server-Sent Events (SSE)</a> which are only unidirectional.</p><p>Additionally, the client application should have some sort of background job mechanism to ping GPS location while the application is in the background.</p><p><em>Note: Learn more about <a href="https://karanpratapsingh.com/courses/system-design/long-polling-websockets-server-sent-events" target="_blank" rel="noopener noreferrer">Long polling, WebSockets, Server-Sent Events (SSE)</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="ride-matching">Ride Matching<a href="#ride-matching" class="hash-link" aria-label="Direct link to Ride Matching" title="Direct link to Ride Matching">​</a></h4><p>We need a way to efficiently store and query nearby drivers. Let&#x27;s explore different solutions we can incorporate into our design.</p><p><strong>SQL</strong></p><p>We already have access to the latitude and longitude of our customers, and with databases like <a href="https://www.postgresql.org" target="_blank" rel="noopener noreferrer">PostgreSQL</a> and <a href="https://www.mysql.com" target="_blank" rel="noopener noreferrer">MySQL</a> we can perform a query to find nearby driver locations given a latitude and longitude (X, Y) within a radius (R).</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> locations </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> lat </span><span class="token operator" style="color:#393A34">BETWEEN</span><span class="token plain"> X</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">R </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> X</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">R </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> long </span><span class="token operator" style="color:#393A34">BETWEEN</span><span class="token plain"> Y</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">R </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> Y</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">R</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, this is not scalable, and performing this query on large datasets will be quite slow.</p><p><strong>Geohashing</strong></p><p>Geohashing is a <a href="https://en.wikipedia.org/wiki/Address_geocoding" target="_blank" rel="noopener noreferrer">geocoding</a> method used to encode geographic coordinates such as latitude and longitude into short alphanumeric strings. It was created by <a href="https://twitter.com/gniemeyer" target="_blank" rel="noopener noreferrer">Gustavo Niemeyer</a> in 2008.</p><p>Geohash is a hierarchical spatial index that uses Base-32 alphabet encoding, the first character in a geohash identifies the initial location as one of the 32 cells. This cell will also contain 32 cells. This means that to represent a point, the world is recursively divided into smaller and smaller cells with each additional bit until the desired precision is attained. The precision factor also determines the size of the cell.</p><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-IV/geohashing-and-quadtrees/geohashing.png" alt="geohashing" class="img_ev3q"></p><p>For example, San Francisco with coordinates <code>37.7564, -122.4016</code> can be represented in geohash as <code>9q8yy9mf</code>.</p><p>Now, using the customer&#x27;s geohash we can determine the nearest available driver by simply comparing it with the driver&#x27;s geohash. For better performance, we will index and store the geohash of the driver in memory for faster retrieval.</p><p><strong>Quadtrees</strong></p><p>A Quadtree is a tree data structure in which each internal node has exactly four children. They are often used to partition a two-dimensional space by recursively subdividing it into four quadrants or regions. Each child or leaf node stores spatial information. Quadtrees are the two-dimensional analog of <a href="https://en.wikipedia.org/wiki/Octree" target="_blank" rel="noopener noreferrer">Octrees</a> which are used to partition three-dimensional space.</p><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-IV/geohashing-and-quadtrees/quadtree.png" alt="quadtree" class="img_ev3q"></p><p>Quadtrees enable us to search points within a two-dimensional range efficiently, where those points are defined as latitude/longitude coordinates or as cartesian (x, y) coordinates.</p><p>We can save further computation by only subdividing a node after a certain threshold.</p><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-IV/geohashing-and-quadtrees/quadtree-subdivision.png" alt="quadtree-subdivision" class="img_ev3q"></p><p>Quadtree seems perfect for our use case, we can update the Quadtree every time we receive a new location update from the driver. To reduce the load on the quadtree servers we can use an in-memory datastore such as <a href="https://redis.io" target="_blank" rel="noopener noreferrer">Redis</a> to cache the latest updates. And with the application of mapping algorithms such as the <a href="https://en.wikipedia.org/wiki/Hilbert_curve" target="_blank" rel="noopener noreferrer">Hilbert curve</a>, we can perform efficient range queries to find nearby drivers for the customer.</p><p><strong>What about race conditions?</strong></p><p>Race conditions can easily occur when a large number of customers will be requesting rides simultaneously. To avoid this, we can wrap our ride matching logic in a <a href="https://en.wikipedia.org/wiki/Lock_(computer_science)" target="_blank" rel="noopener noreferrer">Mutex</a> to avoid any race conditions. Furthermore, every action should be transactional in nature.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/transactions" target="_blank" rel="noopener noreferrer">Transactions</a> and <a href="https://karanpratapsingh.com/courses/system-design/distributed-transactions" target="_blank" rel="noopener noreferrer">Distributed Transactions</a>.</em></p><p><strong>How to find the best drivers nearby?</strong></p><p>Once we have a list of nearby drivers from the Quadtree servers, we can perform some sort of ranking based on parameters like average ratings, relevance, past customer feedback, etc. This will allow us to broadcast notifications to the best available drivers first.</p><p><strong>Dealing with high demand</strong></p><p>In cases of high demand, we can use the concept of Surge Pricing. Surge pricing is a dynamic pricing method where prices are temporarily increased as a reaction to increased demand and mostly limited supply. This surge price can be added to the base price of the trip.</p><p><em>For more details, learn how <a href="https://www.uber.com/us/en/drive/driver-app/how-surge-works" target="_blank" rel="noopener noreferrer">surge pricing works</a> with Uber.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="payments">Payments<a href="#payments" class="hash-link" aria-label="Direct link to Payments" title="Direct link to Payments">​</a></h4><p>Handling payments at scale is challenging, to simplify our system we can use a third-party payment processor like <a href="https://stripe.com" target="_blank" rel="noopener noreferrer">Stripe</a> or <a href="https://www.paypal.com" target="_blank" rel="noopener noreferrer">PayPal</a>. Once the payment is complete, the payment processor will redirect the user back to our application and we can set up a <a href="https://en.wikipedia.org/wiki/Webhook" target="_blank" rel="noopener noreferrer">webhook</a> to capture all the payment-related data.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="notifications-2">Notifications<a href="#notifications-2" class="hash-link" aria-label="Direct link to Notifications" title="Direct link to Notifications">​</a></h4><p>Push notifications will be an integral part of our platform. We can use a message queue or a message broker such as <a href="https://kafka.apache.org" target="_blank" rel="noopener noreferrer">Apache Kafka</a> with the notification service to dispatch requests to <a href="https://firebase.google.com/docs/cloud-messaging" target="_blank" rel="noopener noreferrer">Firebase Cloud Messaging (FCM)</a> or <a href="https://developer.apple.com/documentation/usernotifications" target="_blank" rel="noopener noreferrer">Apple Push Notification Service (APNS)</a> which will handle the delivery of the push notifications to user devices.</p><p><em>For more details, refer to the <a href="https://karanpratapsingh.com/courses/system-design/whatsapp#notifications" target="_blank" rel="noopener noreferrer">WhatsApp</a> system design where we discuss push notifications in detail.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="detailed-design-5">Detailed design<a href="#detailed-design-5" class="hash-link" aria-label="Direct link to Detailed design" title="Direct link to Detailed design">​</a></h3><p>It&#x27;s time to discuss our design decisions in detail.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="data-partitioning-4">Data Partitioning<a href="#data-partitioning-4" class="hash-link" aria-label="Direct link to Data Partitioning" title="Direct link to Data Partitioning">​</a></h4><p>To scale out our databases we will need to partition our data. Horizontal partitioning (aka <a href="https://karanpratapsingh.com/courses/system-design/sharding" target="_blank" rel="noopener noreferrer">Sharding</a>) can be a good first step. We can shard our database either based on existing <a href="https://karanpratapsingh.com/courses/system-design/sharding#partitioning-criteria" target="_blank" rel="noopener noreferrer">partition schemes</a> or regions. If we divide the locations into regions using let&#x27;s say zip codes, we can effectively store all the data in a given region on a fixed node. But this can still cause uneven data and load distribution, we can solve this using <a href="https://karanpratapsingh.com/courses/system-design/consistent-hashing" target="_blank" rel="noopener noreferrer">Consistent hashing</a>.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/sharding" target="_blank" rel="noopener noreferrer">Sharding</a> and <a href="https://karanpratapsingh.com/courses/system-design/consistent-hashing" target="_blank" rel="noopener noreferrer">Consistent Hashing</a>.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics-and-analytics-3">Metrics and Analytics<a href="#metrics-and-analytics-3" class="hash-link" aria-label="Direct link to Metrics and Analytics" title="Direct link to Metrics and Analytics">​</a></h4><p>Recording analytics and metrics is one of our extended requirements. We can capture the data from different services and run analytics on the data using <a href="https://spark.apache.org" target="_blank" rel="noopener noreferrer">Apache Spark</a> which is an open-source unified analytics engine for large-scale data processing. Additionally, we can store critical metadata in the views table to increase data points within our data.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="caching-4">Caching<a href="#caching-4" class="hash-link" aria-label="Direct link to Caching" title="Direct link to Caching">​</a></h4><p>In a location services-based platform, caching is important. We have to be able to cache the recent locations of the customers and drivers for fast retrieval. We can use solutions like <a href="https://redis.io" target="_blank" rel="noopener noreferrer">Redis</a> or <a href="https://memcached.org" target="_blank" rel="noopener noreferrer">Memcached</a> but what kind of cache eviction policy would best fit our needs?</p><p><strong>Which cache eviction policy to use?</strong></p><p><a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_(LRU)" target="_blank" rel="noopener noreferrer">Least Recently Used (LRU)</a> can be a good policy for our system. In this policy, we discard the least recently used key first.</p><p><strong>How to handle cache miss?</strong></p><p>Whenever there is a cache miss, our servers can hit the database directly and update the cache with the new entries.</p><p><em>For more details, refer to <a href="https://karanpratapsingh.com/courses/system-design/caching" target="_blank" rel="noopener noreferrer">Caching</a>.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="identify-and-resolve-bottlenecks-5">Identify and resolve bottlenecks<a href="#identify-and-resolve-bottlenecks-5" class="hash-link" aria-label="Direct link to Identify and resolve bottlenecks" title="Direct link to Identify and resolve bottlenecks">​</a></h3><p><img loading="lazy" src="https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-V/uber/uber-advanced-design.png" alt="uber-advanced-design" class="img_ev3q"></p><p>Let us identify and resolve bottlenecks such as single points of failure in our design:</p><ul><li>&quot;What if one of our services crashes?&quot;</li><li>&quot;How will we distribute our traffic between our components?&quot;</li><li>&quot;How can we reduce the load on our database?&quot;</li><li>&quot;How to improve the availability of our cache?&quot;</li><li>&quot;How can we make our notification system more robust?&quot;</li></ul><p>To make our system more resilient we can do the following:</p><ul><li>Running multiple instances of each of our services.</li><li>Introducing <a href="https://karanpratapsingh.com/courses/system-design/load-balancing" target="_blank" rel="noopener noreferrer">load balancers</a> between clients, servers, databases, and cache servers.</li><li>Using multiple read replicas for our databases.</li><li>Multiple instances and replicas for our distributed cache.</li><li>Exactly once delivery and message ordering is challenging in a distributed system, we can use a dedicated <a href="https://karanpratapsingh.com/courses/system-design/message-brokers" target="_blank" rel="noopener noreferrer">message broker</a> such as <a href="https://kafka.apache.org" target="_blank" rel="noopener noreferrer">Apache Kafka</a> or <a href="https://nats.io" target="_blank" rel="noopener noreferrer">NATS</a> to make our notification system more robust.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/imwito/imwito.github.io/tree/main/docs/system-design/chapter5.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/system-design/chapter4"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Chapter 4</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/tutorial---basics"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Tutorial - Basics</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#system-design-interviews" class="table-of-contents__link toc-highlight">System Design Interviews</a><ul><li><a href="#requirements-clarifications" class="table-of-contents__link toc-highlight">Requirements clarifications</a></li><li><a href="#estimation-and-constraints" class="table-of-contents__link toc-highlight">Estimation and Constraints</a></li><li><a href="#data-model-design" class="table-of-contents__link toc-highlight">Data model design</a></li><li><a href="#api-design" class="table-of-contents__link toc-highlight">API design</a></li><li><a href="#high-level-component-design" class="table-of-contents__link toc-highlight">High-level component design</a></li><li><a href="#detailed-design" class="table-of-contents__link toc-highlight">Detailed design</a></li><li><a href="#identify-and-resolve-bottlenecks" class="table-of-contents__link toc-highlight">Identify and resolve bottlenecks</a></li></ul></li><li><a href="#url-shortener" class="table-of-contents__link toc-highlight">URL Shortener</a><ul><li><a href="#what-is-a-url-shortener" class="table-of-contents__link toc-highlight">What is a URL Shortener?</a></li><li><a href="#why-do-we-need-a-url-shortener" class="table-of-contents__link toc-highlight">Why do we need a URL shortener?</a></li><li><a href="#requirements" class="table-of-contents__link toc-highlight">Requirements</a></li><li><a href="#estimation-and-constraints-1" class="table-of-contents__link toc-highlight">Estimation and Constraints</a></li><li><a href="#high-level-estimate" class="table-of-contents__link toc-highlight">High-level estimate</a></li><li><a href="#data-model-design-1" class="table-of-contents__link toc-highlight">Data model design</a></li><li><a href="#api-design-1" class="table-of-contents__link toc-highlight">API design</a></li><li><a href="#high-level-design" class="table-of-contents__link toc-highlight">High-level design</a></li><li><a href="#detailed-design-1" class="table-of-contents__link toc-highlight">Detailed design</a></li><li><a href="#identify-and-resolve-bottlenecks-1" class="table-of-contents__link toc-highlight">Identify and resolve bottlenecks</a></li></ul></li><li><a href="#whatsapp" class="table-of-contents__link toc-highlight">WhatsApp</a><ul><li><a href="#what-is-whatsapp" class="table-of-contents__link toc-highlight">What is WhatsApp?</a></li><li><a href="#requirements-1" class="table-of-contents__link toc-highlight">Requirements</a></li><li><a href="#estimation-and-constraints-2" class="table-of-contents__link toc-highlight">Estimation and Constraints</a></li><li><a href="#bandwidth-1" class="table-of-contents__link toc-highlight">Bandwidth</a></li><li><a href="#high-level-estimate-1" class="table-of-contents__link toc-highlight">High-level estimate</a></li><li><a href="#data-model-design-2" class="table-of-contents__link toc-highlight">Data model design</a></li><li><a href="#api-design-2" class="table-of-contents__link toc-highlight">API design</a></li><li><a href="#high-level-design-1" class="table-of-contents__link toc-highlight">High-level design</a></li><li><a href="#detailed-design-2" class="table-of-contents__link toc-highlight">Detailed design</a></li><li><a href="#identify-and-resolve-bottlenecks-2" class="table-of-contents__link toc-highlight">Identify and resolve bottlenecks</a></li></ul></li><li><a href="#twitter" class="table-of-contents__link toc-highlight">Twitter</a><ul><li><a href="#what-is-twitter" class="table-of-contents__link toc-highlight">What is Twitter?</a></li><li><a href="#requirements-2" class="table-of-contents__link toc-highlight">Requirements</a></li><li><a href="#estimation-and-constraints-3" class="table-of-contents__link toc-highlight">Estimation and Constraints</a></li><li><a href="#data-model-design-3" class="table-of-contents__link toc-highlight">Data model design</a></li><li><a href="#api-design-3" class="table-of-contents__link toc-highlight">API design</a></li><li><a href="#high-level-design-2" class="table-of-contents__link toc-highlight">High-level design</a></li><li><a href="#detailed-design-3" class="table-of-contents__link toc-highlight">Detailed design</a></li><li><a href="#identify-and-resolve-bottlenecks-3" class="table-of-contents__link toc-highlight">Identify and resolve bottlenecks</a></li></ul></li><li><a href="#netflix" class="table-of-contents__link toc-highlight">Netflix</a><ul><li><a href="#what-is-netflix" class="table-of-contents__link toc-highlight">What is Netflix?</a></li><li><a href="#requirements-3" class="table-of-contents__link toc-highlight">Requirements</a></li><li><a href="#estimation-and-constraints-4" class="table-of-contents__link toc-highlight">Estimation and Constraints</a></li><li><a href="#data-model-design-4" class="table-of-contents__link toc-highlight">Data model design</a></li><li><a href="#api-design-4" class="table-of-contents__link toc-highlight">API design</a></li><li><a href="#high-level-design-3" class="table-of-contents__link toc-highlight">High-level design</a></li><li><a href="#detailed-design-4" class="table-of-contents__link toc-highlight">Detailed design</a></li><li><a href="#identify-and-resolve-bottlenecks-4" class="table-of-contents__link toc-highlight">Identify and resolve bottlenecks</a></li></ul></li><li><a href="#uber" class="table-of-contents__link toc-highlight">Uber</a><ul><li><a href="#what-is-uber" class="table-of-contents__link toc-highlight">What is Uber?</a></li><li><a href="#requirements-4" class="table-of-contents__link toc-highlight">Requirements</a></li><li><a href="#estimation-and-constraints-5" class="table-of-contents__link toc-highlight">Estimation and Constraints</a></li><li><a href="#data-model-design-5" class="table-of-contents__link toc-highlight">Data model design</a></li><li><a href="#api-design-5" class="table-of-contents__link toc-highlight">API design</a></li><li><a href="#high-level-design-4" class="table-of-contents__link toc-highlight">High-level design</a></li><li><a href="#detailed-design-5" class="table-of-contents__link toc-highlight">Detailed design</a></li><li><a href="#identify-and-resolve-bottlenecks-5" class="table-of-contents__link toc-highlight">Identify and resolve bottlenecks</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 imwito, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c8929489.js"></script>
<script src="/assets/js/main.ece51ca9.js"></script>
</body>
</html>